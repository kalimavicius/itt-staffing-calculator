<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITU Personalo Skaičiuoklė v6.1 - Modernizuota lovų bazės sistema</title>
    <style>
        /* Modern CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --dark: #1e293b;
            --gray: #64748b;
            --light-gray: #f1f5f9;
            --white: #ffffff;
            --border: #e2e8f0;
            
            /* Staff type colors - Updated color scheme */
            --doctor-color: #3b82f6;  /* Blue tones */
            --nurse-color: #10b981;   /* Green tones */
            --assistant-color: #fbbf24; /* Yellow tones */
            
            /* Gap colors - new scheme */
            --gap-zero: #10b981;
            --gap-shortage: #3b82f6;
            --gap-surplus: #ef4444;
            
            /* Required line color */
            --required-color: #f59e0b;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1900px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header Styles - Smaller and more modern */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-lg);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            position: relative;
            z-index: 1;
        }

        .header .subtitle {
            font-size: 0.95rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .version-badge {
            display: inline-block;
            background: var(--success);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Dashboard Styles - Smaller cards */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            border-radius: 10px 10px 0 0;
        }

        .stat-icon {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
            opacity: 0.8;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 0.2rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .stat-value.zero { color: var(--gap-zero); }
        .stat-value.shortage { color: var(--gap-shortage); }
        .stat-value.surplus { color: var(--gap-surplus); }
        .stat-value.warning { color: var(--warning); }

        /* Tab Styles */
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1.5rem;
            background: var(--white);
            padding: 0.4rem;
            border-radius: 10px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 0.6rem 1rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--gray);
        }

        .tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
        }

        .tab:hover:not(.active) {
            background: var(--light-gray);
            color: var(--dark);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Calculator Section Styles */
        .calculator-section {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn-primary { 
            background: var(--primary); 
            color: white; 
        }
        .btn-primary:hover { 
            background: var(--primary-hover); 
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }

        .btn-success { 
            background: var(--success); 
            color: white; 
        }
        .btn-success:hover { 
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        .btn-warning { 
            background: var(--warning); 
            color: white; 
        }

        .btn-danger { 
            background: var(--danger); 
            color: white; 
        }

        .btn-secondary { 
            background: var(--light-gray); 
            color: var(--dark); 
            border: 1px solid var(--border);
        }

        .btn-sm {
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            background: var(--white);
        }

        th, td {
            padding: 0.6rem 0.4rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
        }

        th:last-child, td:last-child {
            border-right: none;
        }

        th {
            background: var(--light-gray);
            font-weight: 600;
            color: var(--dark);
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.75rem;
        }

        tr:hover {
            background: #f8fafc;
        }

        .totals-row {
            background: var(--light-gray) !important;
            font-weight: 700;
            border-top: 2px solid var(--primary);
        }

        /* Input Styles - Always show borders */
        input, select {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.4rem 0.5rem;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            width: 100%;
        }

        input:hover, select:hover {
            border-color: #cbd5e1;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        input[type="number"] {
            text-align: center;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
        }

        /* Column width adjustments */
        th:nth-child(1), td:nth-child(1) { /* Skyrius */
            min-width: 80px;
            max-width: 100px;
        }

        th:nth-child(2), td:nth-child(2) { /* Pareigos */
            min-width: 100px;
        }

        th:nth-child(3), td:nth-child(3) { /* Lovos */
            min-width: 60px;
            max-width: 70px;
        }

        th:nth-child(4), td:nth-child(4) { /* Postai */
            min-width: 50px;
            max-width: 60px;
        }

        th:nth-child(5), td:nth-child(5) { /* Pamaina */
            min-width: 70px;
        }

        th:nth-child(6), td:nth-child(6) { /* Etatai postui */
            min-width: 70px;
            max-width: 80px;
        }

        th:nth-child(7), td:nth-child(7) { /* Papildomi et. */
            min-width: 70px;
            max-width: 80px;
        }

        th:nth-child(8), td:nth-child(8) { /* Reikia */
            min-width: 60px;
            max-width: 70px;
        }

        /* Staff Type Styling */
        .staff-type-doctor {
            background: rgba(59, 130, 246, 0.05) !important;  /* Blue */
            border-left: 3px solid var(--doctor-color) !important;
        }

        .staff-type-nurse {
            background: rgba(16, 185, 129, 0.05) !important;  /* Green */
            border-left: 3px solid var(--nurse-color) !important;
        }

        .staff-type-assistant {
            background: rgba(251, 191, 36, 0.05) !important;  /* Yellow */
            border-left: 3px solid var(--assistant-color) !important;
        }

        /* Required Field Styling */
        .required-cell {
            position: relative;
            padding: 0 !important;
        }

        .required-value {
            width: 100%;
            text-align: center;
            font-weight: 600;
            padding: 0.6rem 0.4rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .required-value.calculated {
            background: rgba(251, 191, 36, 0.1);
            border-color: rgba(251, 191, 36, 0.3);
            color: #d97706;
        }

        .required-value.manual {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
            color: #7c3aed;
        }

        .required-value:hover {
            background: rgba(37, 99, 235, 0.1);
            border-color: var(--primary);
        }

        .manual-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--nurse-color);
            color: white;
            font-size: 0.5rem;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: 700;
        }

        /* Gap Badge Styles */
        .gap-badge {
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.7rem;
            text-align: center;
        }

        .gap-zero {
            background: rgba(16, 185, 129, 0.1);
            color: var(--gap-zero);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .gap-shortage {
            background: rgba(59, 130, 246, 0.1);
            color: var(--gap-shortage);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .gap-surplus {
            background: rgba(239, 68, 68, 0.1);
            color: var(--gap-surplus);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Priority Badge */
        .priority-badge {
            padding: 0.15rem 0.3rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 700;
            background: var(--warning);
            color: white;
        }

        /* Chart Section */
        .chart-section {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
        }

        .chart-container {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        /* Beds input styling */
        .beds-input {
            background: rgba(16, 185, 129, 0.05) !important;
            border-color: rgba(16, 185, 129, 0.3) !important;
            font-weight: 600;
        }

        .beds-input:focus {
            border-color: var(--success) !important;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1) !important;
        }

        /* Auto-calculated postai */
        .postai-calculated {
            background: rgba(37, 99, 235, 0.05) !important;
            color: var(--primary);
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .section-header {
                flex-direction: column;
                align-items: stretch;
                gap: 0.75rem;
            }
            
            .quick-actions {
                justify-content: center;
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1.25rem;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-width: 350px;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 3px solid var(--success);
        }

        .toast.error {
            border-left: 3px solid var(--danger);
        }

        .toast.info {
            border-left: 3px solid var(--info);
        }

        .toast.warning {
            border-left: 3px solid var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Planning Input Styling */
        .planning-input {
            background: rgba(16, 185, 129, 0.05) !important;
            border-color: rgba(16, 185, 129, 0.3) !important;
        }

        .planning-input:focus {
            border-color: var(--success) !important;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.1) !important;
        }

        /* Export Section */
        .export-section {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding: 1.5rem;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }

        /* Help Section - also used for analysis cards */
        .help-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            box-shadow: var(--shadow-sm);
        }

        .help-card h3 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.9rem;
        }

        .help-card ul {
            color: var(--gray);
            margin-left: 1.25rem;
            line-height: 1.5;
            font-size: 0.8rem;
        }

        .help-card li {
            margin: 0.3rem 0;
        }

        .help-card p {
            font-size: 0.8rem;
            margin: 0.25rem 0;
        }

        /* Analysis cards specific styling */
        .analysis-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            box-shadow: var(--shadow-sm);
        }

        .analysis-card h3 {
            color: var(--primary);
            margin-bottom: 0.4rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.85rem;
        }

        .analysis-card p {
            font-size: 0.75rem;
            margin: 0.2rem 0;
            color: var(--dark);
        }

        /* Help tab specific cards - different from analysis cards */
        #help-tab .help-card {
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        #help-tab .help-card h3 {
            font-size: 0.95rem;
            margin-bottom: 0.6rem;
        }

        #help-tab .help-card ul {
            font-size: 0.825rem;
            line-height: 1.6;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.8rem; }
        .text-xs { font-size: 0.7rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ITU Personalo Skaičiuoklė <span class="version-badge">v6.1</span></h1>
            <p class="subtitle">Modernizuota lovų bazės personalo planavimo sistema</p>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
            <div class="stat-card">
                <div class="stat-icon">🏥</div>
                <div class="stat-label">Skyriai</div>
                <div class="stat-value" id="totalUnits">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🛏️</div>
                <div class="stat-label">Lovos</div>
                <div class="stat-value" id="totalBeds">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">👨‍⚕️</div>
                <div class="stat-label">Gydytojų etatai</div>
                <div class="stat-value" id="doctorFTE">0.000</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">👩‍⚕️</div>
                <div class="stat-label">Slaugytojų etatai</div>
                <div class="stat-value" id="nurseFTE">0.000</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🤝</div>
                <div class="stat-label">Padėjėjų etatai</div>
                <div class="stat-value" id="assistantFTE">0.000</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🎯</div>
                <div class="stat-label">Reikia etatų</div>
                <div class="stat-value" id="totalRequired">0.000</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">👥</div>
                <div class="stat-label">Esami etatai</div>
                <div class="stat-value" id="totalCurrent">0.000</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⚖️</div>
                <div class="stat-label">Balansas</div>
                <div class="stat-value" id="totalBalance">0.000</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">⚠️</div>
                <div class="stat-label">Trūkumai</div>
                <div class="stat-value warning" id="shortageUnits">0</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('calculator')">📊 Skaičiuoklė</button>
            <button class="tab" onclick="switchTab('analysis')">📈 Analizė</button>
            <button class="tab" onclick="switchTab('help')">❓ Pagalba</button>
        </div>

        <!-- Calculator Tab -->
        <div id="calculator-tab" class="tab-content active">
            <!-- Main Units Section -->
            <div class="calculator-section">
                <div class="section-header">
                    <div class="section-title">
                        <span style="font-size: 1.3em;">🏥</span>
                        Pagrindiniai ITS skyriai
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-success btn-sm" onclick="addMainUnit()">➕ Pridėti</button>
                        <button class="btn btn-danger btn-sm" onclick="removeMainUnit()">➖ Šalinti</button>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="btn btn-secondary btn-sm" onclick="resetMainDefaults()">🔄 Atkurti</button>
                    <button class="btn btn-secondary btn-sm" onclick="clearMainAdditional()">🧹 Valyti papild.</button>
                    <button class="btn btn-secondary btn-sm" onclick="clearMainManual()">🔢 Valyti rankinius</button>
                    <button class="btn btn-secondary btn-sm" onclick="autoConfigureMain()">🤖 Auto konfig.</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Skyrius</th>
                                <th>Pareigos</th>
                                <th>Lovos</th>
                                <th>Postai</th>
                                <th>Pamaina</th>
                                <th>Etatai postui</th>
                                <th>Papildomi et.</th>
                                <th>Reikia</th>
                                <th>Esami</th>
                                <th>Planas</th>
                                <th>Liepa</th>
                                <th>Skirtumas</th>
                                <th>Skirtumas %</th>
                                <th>Prioritetas</th>
                                <th>Kritinis</th>
                            </tr>
                        </thead>
                        <tbody id="mainUnitsBody"></tbody>
                        <tfoot>
                            <tr class="totals-row">
                                <td><strong>VISO:</strong></td>
                                <td>-</td>
                                <td id="mainTotalBeds" class="text-center font-bold">0</td>
                                <td id="mainTotalStations" class="text-center font-bold">0</td>
                                <td>-</td>
                                <td>-</td>
                                <td id="mainTotalAdditional" class="text-center font-bold">0.000</td>
                                <td id="mainTotalRequired" class="text-center font-bold">0.000</td>
                                <td id="mainTotalCurrent" class="text-center font-bold">0.000</td>
                                <td id="mainTotalNearFuture" class="text-center font-bold">0.000</td>
                                <td id="mainTotalAfterJuly" class="text-center font-bold">0.000</td>
                                <td id="mainTotalGap" class="text-center font-bold">0.000</td>
                                <td id="mainTotalGapPercent" class="text-center font-bold">0.0%</td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Specialized Units Section -->
            <div class="calculator-section">
                <div class="section-header">
                    <div class="section-title">
                        <span style="font-size: 1.3em;">🏢</span>
                        Specializuoti skyriai
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-success btn-sm" onclick="addSpecUnit()">➕ Pridėti</button>
                        <button class="btn btn-danger btn-sm" onclick="removeSpecUnit()">➖ Šalinti</button>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="btn btn-secondary btn-sm" onclick="resetSpecDefaults()">🔄 Atkurti</button>
                    <button class="btn btn-secondary btn-sm" onclick="clearSpecAdditional()">🧹 Valyti papild.</button>
                    <button class="btn btn-secondary btn-sm" onclick="clearSpecManual()">🔢 Valyti rankinius</button>
                    <button class="btn btn-secondary btn-sm" onclick="autoConfigureSpec()">🤖 Auto konfig.</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Skyrius</th>
                                <th>Pareigos</th>
                                <th>Lovos</th>
                                <th>Postai</th>
                                <th>Pamaina</th>
                                <th>Etatai postui</th>
                                <th>Papildomi et.</th>
                                <th>Reikia</th>
                                <th>Esami</th>
                                <th>Planas</th>
                                <th>Liepa</th>
                                <th>Skirtumas</th>
                                <th>Skirtumas %</th>
                                <th>Prioritetas</th>
                                <th>Kritinis</th>
                            </tr>
                        </thead>
                        <tbody id="specUnitsBody"></tbody>
                        <tfoot>
                            <tr class="totals-row">
                                <td><strong>VISO:</strong></td>
                                <td>-</td>
                                <td id="specTotalBeds" class="text-center font-bold">0</td>
                                <td id="specTotalStations" class="text-center font-bold">0</td>
                                <td>-</td>
                                <td>-</td>
                                <td id="specTotalAdditional" class="text-center font-bold">0.000</td>
                                <td id="specTotalRequired" class="text-center font-bold">0.000</td>
                                <td id="specTotalCurrent" class="text-center font-bold">0.000</td>
                                <td id="specTotalNearFuture" class="text-center font-bold">0.000</td>
                                <td id="specTotalAfterJuly" class="text-center font-bold">0.000</td>
                                <td id="specTotalGap" class="text-center font-bold">0.000</td>
                                <td id="specTotalGapPercent" class="text-center font-bold">0.0%</td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis-tab" class="tab-content">
            <div class="chart-section">
                <h2 style="color: var(--primary); margin-bottom: 0.75rem; font-size: 1.1rem;">📊 Personalo analizė</h2>
                <div class="chart-container">
                    <canvas id="staffChart" width="900" height="450"></canvas>
                </div>
            </div>

            <div class="calculator-section">
                <div class="section-title mb-4" style="font-size: 1rem;">📈 Personalo statistikos</div>
                <div id="analysisContent">
                    <p class="text-center text-sm" style="color: var(--gray);">Statistikos duomenys bus rodomi čia po skaičiavimų...</p>
                </div>
            </div>
        </div>

        <!-- Help Tab -->
        <div id="help-tab" class="tab-content">
            <div class="help-card">
                <h3>🛏️ Lovų bazės skaičiavimas - v6.1</h3>
                <ul>
                    <li><strong>Įveskite lovų skaičių:</strong> Sistema automatiškai apskaičiuos reikalingus postus</li>
                    <li><strong>Gydytojai:</strong> Postai = Lovos ÷ 6 (suapvalinta)</li>
                    <li><strong>Slaugytojai:</strong> Postai = Lovos ÷ 1.5 (suapvalinta)</li>
                    <li><strong>Padėjėjai:</strong> Postai = Lovos ÷ 3 (suapvalinta)</li>
                    <li><strong>Mėlyna spalva:</strong> Automatiškai apskaičiuoti postai pagal lovų skaičių</li>
                    <li>Galite rankiniu būdu koreguoti postų skaičių, jei reikia</li>
                </ul>
            </div>

            <div class="help-card">
                <h3>🎯 Reikia laukas - Pagrindinė funkcija</h3>
                <ul>
                    <li><strong>Automatinis skaičiavimas:</strong> REIKIA = (Postai × Etatai postui) + Papildomi et.</li>
                    <li><strong>Rankinis koregavimas:</strong> Spustelėkite REIKIA lauką norėdami įvesti savo reikšmę</li>
                    <li><strong style="color: #d97706;">Geltona spalva:</strong> Automatiškai apskaičiuota reikšmė</li>
                    <li><strong style="color: #7c3aed;">Violetinė spalva:</strong> Rankiniu būdu įvesta reikšmė (žymima "M")</li>
                    <li>Visos analizės naudoja REIKIA reikšmę skaičiavimams</li>
                </ul>
            </div>

            <div class="help-card">
                <h3>🎨 Spalvų kodavimo sistema</h3>
                <ul>
                    <li><strong style="color: var(--gap-zero);">Žalia spalva:</strong> Tobulas balansas (0.000 skirtumas)</li>
                    <li><strong style="color: var(--gap-shortage);">Mėlyna spalva:</strong> Personalo trūkumas (neigiamas skirtumas)</li>
                    <li><strong style="color: var(--gap-surplus);">Raudona spalva:</strong> Personalo perteklius (teigiamas skirtumas)</li>
                    <li><strong style="color: var(--required-color);">Oranžinė linija:</strong> Reikalingų etatų riba grafike</li>
                </ul>
            </div>

            <div class="help-card">
                <h3>👥 Personalo tipų klasifikacija</h3>
                <ul>
                    <li><strong style="color: var(--doctor-color);">Gydytojai (mėlyna):</strong> Medicininis personalas (gydytojai anesteziologai reanimatologai)</li>
                    <li><strong style="color: var(--nurse-color);">Slaugytojai (žalia):</strong> Anestezijos ir intensyviosios terapijos slaugytojai</li>
                    <li><strong style="color: var(--assistant-color);">Padėjėjai (geltona):</strong> Slaugytojų padėjėjai</li>
                </ul>
            </div>

            <div class="help-card">
                <h3>🔢 Skaičiavimo metodika (3 skaitmenų tikslumas)</h3>
                <ul>
                    <li><strong>Bazinio etato formulė:</strong> Pamainų valandos × 7 dienų ÷ 40 val/sav × 1.25</li>
                    <li><strong>24/7 pamainos:</strong> (24h × 7d) ÷ 40h × 1.25 = 5.250 etato/postui</li>
                    <li><strong>12/7 pamainos:</strong> (12h × 7d) ÷ 40h × 1.25 = 2.625 etato/postui</li>
                    <li><strong>12/6 pamainos:</strong> (12h × 6d) ÷ 40h × 1.25 = 2.250 etato/postui</li>
                    <li><strong>Visi skaičiavimai:</strong> 3 skaitmenų po kablelio tikslumas</li>
                </ul>
            </div>

            <div class="help-card">
                <h3>📋 Reguliavimo pagrindas</h3>
                <ul>
                    <li><strong>Teisinis pagrindas:</strong> LR SAM įsakymas Nr. V-465 (2022-03-02)</li>
                    <li><strong>Pakeitimų įsakymas:</strong> Nr. V-1213 (2024-12-03)</li>
                    <li><strong>17 punktas:</strong> Personalo normatyvų reikalavimai</li>
                    <li><strong>X skyrius:</strong> Papildomo mokėjimo tvarka</li>
                </ul>
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <button class="btn btn-primary" onclick="exportCSV()">📊 Eksportuoti CSV</button>
            <button class="btn btn-success" onclick="exportReport()">📋 Detalus raportas</button>
            <button class="btn btn-secondary" onclick="saveConfig()">💾 Išsaugoti konfigūraciją</button>
            <button class="btn btn-secondary" onclick="loadConfig()">📂 Įkelti konfigūraciją</button>
            <button class="btn btn-secondary" onclick="printReport()">🖨️ Spausdinti</button>
        </div>
    </div>

    <script>
        // ==============================================
        // CONSTANTS AND CONFIGURATION
        // ==============================================
        
        const FTE_STANDARDS = {
            '24/7': 5.250,
            '12/7': 2.625,
            '12/6': 2.250,
            '12/5': 1.875,
            '10/6': 1.875,
            '8/5': 1.250
        };

        const STAFF_TYPES = {
            'Gydytojai': { color: '#3b82f6', icon: '👨‍⚕️', bedsPerStation: 6 },    /* Blue */
            'Slaugytojai': { color: '#10b981', icon: '👩‍⚕️', bedsPerStation: 1.5 }, /* Green */
            'Padėjėjai': { color: '#fbbf24', icon: '🤝', bedsPerStation: 3 }         /* Yellow */
        };

        const PRECISION = 3; // 3 decimal places

        // ==============================================
        // STATE MANAGEMENT
        // ==============================================
        
        let mainUnits = [
            { 
                name: 'I ITS', 
                staffType: 'Gydytojai',
                beds: 18,
                stations: 3, 
                autoStations: true,
                shiftType: '24/7', 
                additionalFTE: 1.000, 
                manualRequired: null,
                currentFTE: 18.000, 
                nearFutureFTE: 18.500, 
                afterJulyFTE: 20.000, 
                isCritical: false 
            },
            { 
                name: 'II ITS', 
                staffType: 'Slaugytojai',
                beds: 18,
                stations: 12, 
                autoStations: true,
                shiftType: '24/7', 
                additionalFTE: 1.000,
                manualRequired: null,
                currentFTE: 64.000, 
                nearFutureFTE: 65.000, 
                afterJulyFTE: 66.000, 
                isCritical: false 
            },
            { 
                name: 'III ITS', 
                staffType: 'Gydytojai',
                beds: 12,
                stations: 2, 
                autoStations: true,
                shiftType: '24/7', 
                additionalFTE: 0.750,
                manualRequired: null,
                currentFTE: 11.750, 
                nearFutureFTE: 11.750, 
                afterJulyFTE: 12.500, 
                isCritical: false 
            },
            { 
                name: 'IV ITS', 
                staffType: 'Padėjėjai',
                beds: 6,
                stations: 2, 
                autoStations: true,
                shiftType: '24/7', 
                additionalFTE: 0.250,
                manualRequired: null,
                currentFTE: 10.500, 
                nearFutureFTE: 10.500, 
                afterJulyFTE: 11.000, 
                isCritical: false 
            }
        ];

        let specUnits = [
            { 
                name: 'PTP', 
                staffType: 'Gydytojai',
                beds: 6,
                stations: 1, 
                autoStations: true,
                shiftType: '12/6', 
                additionalFTE: 0.250,
                manualRequired: null,
                currentFTE: 3.000, 
                nearFutureFTE: 3.000, 
                afterJulyFTE: 3.500, 
                isCritical: false 
            },
            { 
                name: 'RDPKP', 
                staffType: 'Slaugytojai',
                beds: 8,
                stations: 5, 
                autoStations: true,
                shiftType: '12/6', 
                additionalFTE: 0.000,
                manualRequired: null,
                currentFTE: 11.250, 
                nearFutureFTE: 11.250, 
                afterJulyFTE: 12.000, 
                isCritical: false 
            }
        ];

        // ==============================================
        // UTILITY FUNCTIONS
        // ==============================================
        
        function formatNumber(value, decimals = PRECISION) {
            if (value === null || value === undefined || isNaN(value)) return '0.' + '0'.repeat(decimals);
            return Number(value).toFixed(decimals);
        }

        function formatPercentage(value, decimals = 1) {
            if (value === null || value === undefined || isNaN(value)) return '0.0%';
            return Number(value).toFixed(decimals) + '%';
        }

        function isZeroValue(value, threshold = 0.001) {
            return Math.abs(value) < threshold;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = { 
                success: '✅', 
                error: '❌', 
                warning: '⚠️', 
                info: 'ℹ️' 
            };
            
            toast.innerHTML = `${icons[type] || '📄'} ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // ==============================================
        // CALCULATION FUNCTIONS
        // ==============================================
        
        function calculateStationsFromBeds(beds, staffType) {
            const bedsPerStation = STAFF_TYPES[staffType]?.bedsPerStation || 1;
            return Math.round(beds / bedsPerStation);
        }

        function calculateUnit(unit) {
            // Auto-calculate stations if needed
            if (unit.autoStations && unit.beds) {
                unit.stations = calculateStationsFromBeds(unit.beds, unit.staffType);
            }

            const baseFTEPerStation = FTE_STANDARDS[unit.shiftType] || 5.250;
            unit.baseRequired = unit.stations * baseFTEPerStation;
            
            // Calculate total required etatai
            const calculatedRequired = unit.baseRequired + (unit.additionalFTE || 0);
            unit.totalRequired = unit.manualRequired !== null ? unit.manualRequired : calculatedRequired;
            unit.isManualRequired = unit.manualRequired !== null;
            
            // Calculate gaps and metrics
            unit.gap = unit.currentFTE - unit.totalRequired;
            unit.gapPercentage = unit.totalRequired > 0 ? (unit.gap / unit.totalRequired) * 100 : 0;
            
            // Priority calculation
            const weightFactor = unit.isCritical ? 1.5 : 1.0;
            unit.priorityScore = Math.abs(unit.gapPercentage) * weightFactor;
            
            // Future planning gaps
            unit.nearFutureGap = (unit.nearFutureFTE || unit.currentFTE) - unit.totalRequired;
            unit.afterJulyGap = (unit.afterJulyFTE || unit.nearFutureFTE || unit.currentFTE) - unit.totalRequired;
            
            return unit;
        }

        function calculatePriorities(units) {
            // Reset priorities
            units.forEach(unit => unit.priority = null);
            
            // Find units with shortages
            const unitsWithShortages = units.filter(u => u.gap < -0.001);
            
            if (unitsWithShortages.length > 0) {
                // Sort by priority score (descending)
                const sortedShortages = [...unitsWithShortages].sort((a, b) => b.priorityScore - a.priorityScore);
                
                // Assign priorities
                sortedShortages.forEach((sortedUnit, index) => {
                    const originalUnit = units.find(u => u === sortedUnit);
                    if (originalUnit) originalUnit.priority = index + 1;
                });
            }
        }

        // ==============================================
        // TAB MANAGEMENT
        // ==============================================
        
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Special handling for analysis tab
            if (tabName === 'analysis') {
                setTimeout(() => {
                    drawChart();
                    updateAnalysisContent();
                }, 100);
            }
        }

        // ==============================================
        // MANUAL REQUIRED FIELD TOGGLE
        // ==============================================
        
        function toggleRequiredField(prefix, index) {
            const units = prefix === 'main' ? mainUnits : specUnits;
            const unit = units[index];
            
            if (unit.manualRequired === null) {
                // Switch to manual mode
                const calculatedValue = unit.baseRequired + (unit.additionalFTE || 0);
                const newValue = prompt('Įveskite reikalingus etatus:', calculatedValue.toFixed(PRECISION));
                
                if (newValue !== null && !isNaN(parseFloat(newValue))) {
                    unit.manualRequired = parseFloat(newValue);
                    updateAll();
                    showToast('🔢 Perjungta į rankinį režimą', 'info');
                }
            } else {
                // Switch back to calculated mode
                if (confirm('Grįžti į automatinį skaičiavimą?')) {
                    unit.manualRequired = null;
                    updateAll();
                    showToast('🔄 Grįžta į automatinį skaičiavimą', 'success');
                }
            }
        }

        // ==============================================
        // TABLE RENDERING
        // ==============================================
        
        function renderUnitsTable(units, bodyId, prefix) {
            const tbody = document.getElementById(bodyId);
            tbody.innerHTML = '';
            
            let totalBeds = 0;
            let totalStations = 0;
            let totalAdditional = 0;
            let totalRequired = 0;
            let totalCurrent = 0;
            let totalNearFuture = 0;
            let totalAfterJuly = 0;
            
            // Calculate all units and priorities
            units.forEach(unit => calculateUnit(unit));
            calculatePriorities(units);
            
            // Render each unit
            units.forEach((unit, index) => {
                const baseFTEPerStation = FTE_STANDARDS[unit.shiftType] || 5.250;
                const isZeroGap = isZeroValue(unit.gap);
                const isShortage = unit.gap < -0.001;
                const isSurplus = unit.gap > 0.001;
                
                // Determine gap styling
                let gapClass = 'gap-zero';
                if (isShortage) gapClass = 'gap-shortage';
                else if (isSurplus) gapClass = 'gap-surplus';
                
                // Determine staff type class
                let staffTypeClass = '';
                if (unit.staffType === 'Gydytojai') staffTypeClass = 'staff-type-doctor';
                else if (unit.staffType === 'Slaugytojai') staffTypeClass = 'staff-type-nurse';
                else if (unit.staffType === 'Padėjėjai') staffTypeClass = 'staff-type-assistant';
                
                const row = tbody.insertRow();
                row.className = staffTypeClass;
                
                row.innerHTML = `
                    <td>
                        <input type="text" value="${unit.name}" onchange="updateUnit('${prefix}', ${index}, 'name', this.value)">
                    </td>
                    <td>
                        <select onchange="updateUnit('${prefix}', ${index}, 'staffType', this.value)">
                            <option value="Gydytojai" ${unit.staffType === 'Gydytojai' ? 'selected' : ''}>Gydytojai</option>
                            <option value="Slaugytojai" ${unit.staffType === 'Slaugytojai' ? 'selected' : ''}>Slaugytojai</option>
                            <option value="Padėjėjai" ${unit.staffType === 'Padėjėjai' ? 'selected' : ''}>Padėjėjai</option>
                        </select>
                    </td>
                    <td class="text-center">
                        <input type="number" value="${unit.beds || 0}" min="0" step="1" class="beds-input" onchange="updateUnit('${prefix}', ${index}, 'beds', this.value)">
                    </td>
                    <td class="text-center">
                        <input type="number" value="${unit.stations}" min="0" step="1" class="${unit.autoStations ? 'postai-calculated' : ''}" onchange="updateUnit('${prefix}', ${index}, 'stations', this.value)">
                    </td>
                    <td class="text-center">
                        <select onchange="updateUnit('${prefix}', ${index}, 'shiftType', this.value)">
                            ${Object.keys(FTE_STANDARDS).map(pattern => 
                                `<option value="${pattern}" ${unit.shiftType === pattern ? 'selected' : ''}>${pattern}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td class="text-center" style="color: var(--info); font-weight: 600;">
                        ${formatNumber(baseFTEPerStation)}
                    </td>
                    <td class="text-center">
                        <input type="number" value="${formatNumber(unit.additionalFTE)}" step="0.001" min="0" onchange="updateUnit('${prefix}', ${index}, 'additionalFTE', this.value)">
                    </td>
                    <td class="required-cell">
                        <div class="required-value ${unit.isManualRequired ? 'manual' : 'calculated'}" 
                             onclick="toggleRequiredField('${prefix}', ${index})"
                             title="${unit.isManualRequired ? 'Rankinis įvedimas - spustelėkite keisti' : 'Automatinis skaičiavimas - spustelėkite redaguoti'}">
                            ${formatNumber(unit.totalRequired)}
                            ${unit.isManualRequired ? '<span class="manual-indicator">M</span>' : ''}
                        </div>
                    </td>
                    <td class="text-center">
                        <input type="number" value="${formatNumber(unit.currentFTE)}" step="0.001" min="0" onchange="updateUnit('${prefix}', ${index}, 'currentFTE', this.value)">
                    </td>
                    <td class="text-center">
                        <input type="number" value="${formatNumber(unit.nearFutureFTE || unit.currentFTE)}" step="0.001" min="0" class="planning-input" onchange="updateUnit('${prefix}', ${index}, 'nearFutureFTE', this.value)">
                    </td>
                    <td class="text-center">
                        <input type="number" value="${formatNumber(unit.afterJulyFTE || unit.nearFutureFTE || unit.currentFTE)}" step="0.001" min="0" class="planning-input" onchange="updateUnit('${prefix}', ${index}, 'afterJulyFTE', this.value)">
                    </td>
                    <td class="text-center">
                        <span class="gap-badge ${gapClass}">
                            ${isZeroGap ? '0.000' : (unit.gap >= 0 ? '+' : '') + formatNumber(unit.gap)}
                        </span>
                    </td>
                    <td class="text-center" style="color: ${isZeroGap ? 'var(--gap-zero)' : (isShortage ? 'var(--gap-shortage)' : 'var(--gap-surplus)')}; font-weight: 600;">
                        ${isZeroGap ? '0.0%' : (unit.gapPercentage >= 0 ? '+' : '') + formatPercentage(unit.gapPercentage)}
                    </td>
                    <td class="text-center">
                        ${unit.priority ? `<span class="priority-badge">#${unit.priority}</span>` : '-'}
                    </td>
                    <td class="text-center">
                        <input type="checkbox" ${unit.isCritical ? 'checked' : ''} onchange="updateUnit('${prefix}', ${index}, 'isCritical', this.checked)">
                    </td>
                `;
                
                // Update totals
                totalBeds += unit.beds || 0;
                totalStations += unit.stations;
                totalAdditional += unit.additionalFTE || 0;
                totalRequired += unit.totalRequired;
                totalCurrent += unit.currentFTE;
                totalNearFuture += unit.nearFutureFTE || unit.currentFTE;
                totalAfterJuly += unit.afterJulyFTE || unit.nearFutureFTE || unit.currentFTE;
            });
            
            // Update totals display
            const totalGap = totalCurrent - totalRequired;
            const totalGapPercent = totalRequired > 0 ? (totalGap / totalRequired) * 100 : 0;
            const isZeroTotalGap = isZeroValue(totalGap);
            
            document.getElementById(`${prefix}TotalBeds`).textContent = totalBeds;
            document.getElementById(`${prefix}TotalStations`).textContent = totalStations;
            document.getElementById(`${prefix}TotalAdditional`).textContent = formatNumber(totalAdditional);
            document.getElementById(`${prefix}TotalRequired`).textContent = formatNumber(totalRequired);
            document.getElementById(`${prefix}TotalCurrent`).textContent = formatNumber(totalCurrent);
            document.getElementById(`${prefix}TotalNearFuture`).textContent = formatNumber(totalNearFuture);
            document.getElementById(`${prefix}TotalAfterJuly`).textContent = formatNumber(totalAfterJuly);
            
            const gapEl = document.getElementById(`${prefix}TotalGap`);
            gapEl.textContent = isZeroTotalGap ? '0.000' : (totalGap >= 0 ? '+' : '') + formatNumber(totalGap);
            gapEl.style.color = isZeroTotalGap ? 'var(--gap-zero)' : (totalGap < 0 ? 'var(--gap-shortage)' : 'var(--gap-surplus)');
            
            const gapPercentEl = document.getElementById(`${prefix}TotalGapPercent`);
            gapPercentEl.textContent = isZeroTotalGap ? '0.0%' : (totalGapPercent >= 0 ? '+' : '') + formatPercentage(totalGapPercent);
            gapPercentEl.style.color = isZeroTotalGap ? 'var(--gap-zero)' : (totalGapPercent < 0 ? 'var(--gap-shortage)' : 'var(--gap-surplus)');
        }

        // ==============================================
        // DASHBOARD UPDATE
        // ==============================================
        
        function updateDashboard() {
            const allUnits = [...mainUnits, ...specUnits];
            
            let totalBeds = 0;
            let totalStations = 0;
            let totalRequired = 0;
            let totalCurrent = 0;
            let shortageCount = 0;
            let doctorFTE = 0;
            let nurseFTE = 0;
            let assistantFTE = 0;
            
            allUnits.forEach(unit => {
                calculateUnit(unit);
                totalBeds += unit.beds || 0;
                totalStations += unit.stations;
                totalRequired += unit.totalRequired;
                totalCurrent += unit.currentFTE;
                
                if (unit.gap < -0.001) shortageCount++;
                
                // Count by staff type
                if (unit.staffType === 'Gydytojai') doctorFTE += unit.currentFTE;
                else if (unit.staffType === 'Slaugytojai') nurseFTE += unit.currentFTE;
                else if (unit.staffType === 'Padėjėjai') assistantFTE += unit.currentFTE;
            });
            
            const currentBalance = totalCurrent - totalRequired;
            const isZeroBalance = isZeroValue(currentBalance);
            
            document.getElementById('totalUnits').textContent = allUnits.length;
            document.getElementById('totalBeds').textContent = totalBeds;
            document.getElementById('doctorFTE').textContent = formatNumber(doctorFTE);
            document.getElementById('nurseFTE').textContent = formatNumber(nurseFTE);
            document.getElementById('assistantFTE').textContent = formatNumber(assistantFTE);
            document.getElementById('totalRequired').textContent = formatNumber(totalRequired);
            document.getElementById('totalCurrent').textContent = formatNumber(totalCurrent);
            document.getElementById('shortageUnits').textContent = shortageCount;
            
            const balanceEl = document.getElementById('totalBalance');
            balanceEl.textContent = isZeroBalance ? '0.000' : (currentBalance >= 0 ? '+' : '') + formatNumber(currentBalance);
            balanceEl.className = `stat-value ${isZeroBalance ? 'zero' : (currentBalance < 0 ? 'shortage' : 'surplus')}`;
        }

        // ==============================================
        // UNIT MANAGEMENT FUNCTIONS
        // ==============================================
        
        function updateUnit(prefix, index, field, value) {
            const units = prefix === 'main' ? mainUnits : specUnits;
            
            if (field === 'name' || field === 'shiftType' || field === 'staffType') {
                units[index][field] = value;
                if (field === 'staffType') {
                    // Recalculate stations when staff type changes
                    units[index].autoStations = true;
                }
            } else if (field === 'isCritical') {
                units[index][field] = value;
            } else if (field === 'beds') {
                units[index][field] = parseInt(value) || 0;
                units[index].autoStations = true;
            } else if (field === 'stations') {
                units[index][field] = parseInt(value) || 0;
                units[index].autoStations = false; // Manual override
            } else {
                units[index][field] = parseFloat(value) || 0;
            }
            
            updateAll();
        }

        function addMainUnit() {
            const newUnitNumber = mainUnits.length + 1;
            const romanNumerals = ['', 'I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X'];
            
            mainUnits.push({
                name: newUnitNumber <= 10 ? `${romanNumerals[newUnitNumber]} ITS` : `${newUnitNumber} ITS`,
                staffType: 'Gydytojai',
                beds: 6,
                stations: 1,
                autoStations: true,
                shiftType: '24/7',
                additionalFTE: 0.000,
                manualRequired: null,
                currentFTE: 0.000,
                nearFutureFTE: 0.000,
                afterJulyFTE: 0.000,
                isCritical: false
            });
            updateAll();
            showToast('✅ Pridėtas naujas pagrindinis skyrius', 'success');
        }

        function removeMainUnit() {
            if (mainUnits.length > 1) {
                mainUnits.pop();
                updateAll();
                showToast('ℹ️ Pašalintas pagrindinis skyrius', 'info');
            } else {
                showToast('⚠️ Negalima pašalinti paskutinio skyriaus', 'warning');
            }
        }

        function addSpecUnit() {
            specUnits.push({
                name: `Spec ${specUnits.length + 1}`,
                staffType: 'Gydytojai',
                beds: 6,
                stations: 1,
                autoStations: true,
                shiftType: '12/6',
                additionalFTE: 0.000,
                manualRequired: null,
                currentFTE: 0.000,
                nearFutureFTE: 0.000,
                afterJulyFTE: 0.000,
                isCritical: false
            });
            updateAll();
            showToast('✅ Pridėtas naujas specializuotas skyrius', 'success');
        }

        function removeSpecUnit() {
            if (specUnits.length > 0) {
                specUnits.pop();
                updateAll();
                showToast('ℹ️ Pašalintas specializuotas skyrius', 'info');
            } else {
                showToast('⚠️ Nėra skyrių pašalinimui', 'warning');
            }
        }

        // ==============================================
        // CONFIGURATION FUNCTIONS
        // ==============================================
        
        function resetMainDefaults() {
            if (confirm('Atkurti pagrindinių skyrių numatytuosius nustatymus?')) {
                mainUnits = [
                    { name: 'I ITS', staffType: 'Gydytojai', beds: 18, stations: 3, autoStations: true, shiftType: '24/7', additionalFTE: 1.000, manualRequired: null, currentFTE: 18.000, nearFutureFTE: 18.500, afterJulyFTE: 20.000, isCritical: false },
                    { name: 'II ITS', staffType: 'Slaugytojai', beds: 18, stations: 12, autoStations: true, shiftType: '24/7', additionalFTE: 1.000, manualRequired: null, currentFTE: 64.000, nearFutureFTE: 65.000, afterJulyFTE: 66.000, isCritical: false },
                    { name: 'III ITS', staffType: 'Gydytojai', beds: 12, stations: 2, autoStations: true, shiftType: '24/7', additionalFTE: 0.750, manualRequired: null, currentFTE: 11.750, nearFutureFTE: 11.750, afterJulyFTE: 12.500, isCritical: false },
                    { name: 'IV ITS', staffType: 'Padėjėjai', beds: 6, stations: 2, autoStations: true, shiftType: '24/7', additionalFTE: 0.250, manualRequired: null, currentFTE: 10.500, nearFutureFTE: 10.500, afterJulyFTE: 11.000, isCritical: false }
                ];
                updateAll();
                showToast('🔄 Atkurti numatytieji nustatymai', 'success');
            }
        }

        function resetSpecDefaults() {
            if (confirm('Atkurti specializuotų skyrių numatytuosius nustatymus?')) {
                specUnits = [
                    { name: 'PTP', staffType: 'Gydytojai', beds: 6, stations: 1, autoStations: true, shiftType: '12/6', additionalFTE: 0.250, manualRequired: null, currentFTE: 3.000, nearFutureFTE: 3.000, afterJulyFTE: 3.500, isCritical: false },
                    { name: 'RDPKP', staffType: 'Slaugytojai', beds: 8, stations: 5, autoStations: true, shiftType: '12/6', additionalFTE: 0.000, manualRequired: null, currentFTE: 11.250, nearFutureFTE: 11.250, afterJulyFTE: 12.000, isCritical: false }
                ];
                updateAll();
                showToast('🔄 Atkurti numatytieji nustatymai', 'success');
            }
        }

        function clearMainAdditional() {
            mainUnits.forEach(unit => unit.additionalFTE = 0.000);
            updateAll();
            showToast('🧹 Išvalyti papildomi etatai', 'success');
        }

        function clearSpecAdditional() {
            specUnits.forEach(unit => unit.additionalFTE = 0.000);
            updateAll();
            showToast('🧹 Išvalyti papildomi etatai', 'success');
        }

        function clearMainManual() {
            mainUnits.forEach(unit => unit.manualRequired = null);
            updateAll();
            showToast('🔢 Išvalyti rankiniai REIKIA įvedimai', 'success');
        }

        function clearSpecManual() {
            specUnits.forEach(unit => unit.manualRequired = null);
            updateAll();
            showToast('🔢 Išvalyti rankiniai REIKIA įvedimai', 'success');
        }

        function autoConfigureMain() {
            mainUnits.forEach(unit => {
                unit.additionalFTE = Math.max(0, Math.round(unit.stations * 0.333 * 1000) / 1000);
            });
            updateAll();
            showToast('🤖 Pagrindiniams skyriams pritaikyta išmani konfigūracija', 'success');
        }

        function autoConfigureSpec() {
            specUnits.forEach(unit => {
                unit.additionalFTE = unit.stations > 2 ? 0.500 : 0.250;
            });
            updateAll();
            showToast('🤖 Specializuotiems skyriams pritaikyta išmani konfigūracija', 'success');
        }

        // ==============================================
        // CHART FUNCTIONS
        // ==============================================
        
        function drawChart() {
            const canvas = document.getElementById('staffChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width = 900;
            const height = canvas.height = 450;
            
            ctx.clearRect(0, 0, width, height);
            
            const allUnits = [...mainUnits, ...specUnits].map(unit => {
                calculateUnit(unit);
                return unit;
            });
            
            if (allUnits.length === 0) return;
            
            // Chart configuration
            const padding = { top: 65, right: 80, bottom: 100, left: 80 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            // Find max value for scale
            let maxValue = 0;
            allUnits.forEach(unit => {
                const max = Math.max(unit.totalRequired, unit.currentFTE, unit.nearFutureFTE || 0, unit.afterJulyFTE || 0);
                if (max > maxValue) maxValue = max;
            });
            maxValue = maxValue * 1.1;
            
            // Draw grid
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
                
                ctx.fillStyle = '#64748b';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'right';
                const value = maxValue - (maxValue / 5) * i;
                ctx.fillText(value.toFixed(1), padding.left - 10, y + 4);
            }
            
            // Draw bars
            const barWidth = chartWidth / allUnits.length / 4.5;
            const groupWidth = chartWidth / allUnits.length;
            
            allUnits.forEach((unit, index) => {
                const x = padding.left + groupWidth * index + groupWidth / 2;
                const staffColor = STAFF_TYPES[unit.staffType]?.color || '#3b82f6';
                
                // Bar heights
                const currentHeight = (unit.currentFTE / maxValue) * chartHeight;
                const requiredHeight = (unit.totalRequired / maxValue) * chartHeight;
                const nearFutureHeight = ((unit.nearFutureFTE || unit.currentFTE) / maxValue) * chartHeight;
                const afterJulyHeight = ((unit.afterJulyFTE || unit.nearFutureFTE || unit.currentFTE) / maxValue) * chartHeight;
                
                // Draw current bar (Esami)
                const currentBarX = x - barWidth * 1.5;
                const currentBarY = padding.top + chartHeight - currentHeight;
                
                ctx.fillStyle = staffColor;
                ctx.fillRect(currentBarX, currentBarY, barWidth, currentHeight);
                
                // Add value label on bar
                ctx.fillStyle = '#1e293b';
                ctx.font = '9px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(unit.currentFTE.toFixed(1), currentBarX + barWidth/2, currentBarY - 3);
                
                // Draw required line (Reikia) - Orange color
                const requiredY = padding.top + chartHeight - requiredHeight;
                ctx.strokeStyle = unit.isManualRequired ? '#8b5cf6' : '#f59e0b';
                ctx.lineWidth = 2.5;
                ctx.setLineDash([5, 3]);
                ctx.beginPath();
                ctx.moveTo(x - groupWidth * 0.4, requiredY);
                ctx.lineTo(x + groupWidth * 0.4, requiredY);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Add label for required line
                ctx.fillStyle = unit.isManualRequired ? '#8b5cf6' : '#f59e0b';
                ctx.font = 'bold 9px sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(unit.totalRequired.toFixed(1), x + groupWidth * 0.42, requiredY + 3);
                
                // Future planning bars (lighter colors with proper opacity)
                ctx.fillStyle = staffColor + 'AA';  // 67% opacity
                const nearFutureBarX = x - barWidth * 0.5;
                const nearFutureBarY = padding.top + chartHeight - nearFutureHeight;
                ctx.fillRect(nearFutureBarX, nearFutureBarY, barWidth, nearFutureHeight);
                
                ctx.fillStyle = staffColor + '66';  // 40% opacity
                const afterJulyBarX = x + barWidth * 0.5;
                const afterJulyBarY = padding.top + chartHeight - afterJulyHeight;
                ctx.fillRect(afterJulyBarX, afterJulyBarY, barWidth, afterJulyHeight);
                
                // Unit labels
                ctx.fillStyle = '#1e293b';
                ctx.font = 'bold 12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(unit.name, x, height - 60);
                
                // Staff type
                ctx.fillStyle = staffColor;
                ctx.font = '10px sans-serif';
                ctx.fillText(unit.staffType, x, height - 45);
                
                // Beds count
                ctx.fillStyle = '#64748b';
                ctx.font = '9px sans-serif';
                ctx.fillText(`${unit.beds || 0} lovos`, x, height - 30);
                
                // Gap value
                const isZeroGap = isZeroValue(unit.gap);
                ctx.font = 'bold 11px sans-serif';
                if (isZeroGap) {
                    ctx.fillStyle = '#10b981';
                    ctx.fillText('0.000', x, height - 15);
                } else if (unit.gap < 0) {
                    ctx.fillStyle = '#3b82f6';
                    ctx.fillText(unit.gap.toFixed(3), x, height - 15);
                } else {
                    ctx.fillStyle = '#ef4444';
                    ctx.fillText(`+${unit.gap.toFixed(3)}`, x, height - 15);
                }
            });
            
            // Legend
            const legendY = 25;
            let legendX = padding.left;
            
            // Current bar legend
            ctx.fillStyle = '#3b82f6';
            ctx.fillRect(legendX, legendY - 8, 15, 10);
            ctx.fillStyle = '#1e293b';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('Esami', legendX + 20, legendY);
            
            // Required line legend
            legendX += 70;
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 3]);
            ctx.beginPath();
            ctx.moveTo(legendX, legendY - 3);
            ctx.lineTo(legendX + 15, legendY - 3);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = '#1e293b';
            ctx.fillText('Reikia', legendX + 20, legendY);
            
            // Plans legend
            legendX += 70;
            ctx.fillStyle = '#3b82f680';
            ctx.fillRect(legendX, legendY - 8, 15, 10);
            ctx.fillStyle = '#1e293b';
            ctx.fillText('Planas', legendX + 20, legendY);
            
            legendX += 70;
            ctx.fillStyle = '#3b82f660';
            ctx.fillRect(legendX, legendY - 8, 15, 10);
            ctx.fillStyle = '#1e293b';
            ctx.fillText('Liepa', legendX + 20, legendY);
            
            // Manual required legend
            legendX += 60;
            ctx.strokeStyle = '#8b5cf6';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 3]);
            ctx.beginPath();
            ctx.moveTo(legendX, legendY - 3);
            ctx.lineTo(legendX + 15, legendY - 3);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = '#1e293b';
            ctx.fillText('Rankinis', legendX + 20, legendY);
            
            // Chart title
            ctx.fillStyle = '#1e293b';
            ctx.font = 'bold 16px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Personalo analizė pagal skyrius', width / 2, 20);
            
            // Y-axis label
            ctx.save();
            ctx.translate(20, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.font = '13px sans-serif';
            ctx.fillStyle = '#64748b';
            ctx.textAlign = 'center';
            ctx.fillText('Etatai', 0, 0);
            ctx.restore();
        }

        function updateAnalysisContent() {
            const allUnits = [...mainUnits, ...specUnits];
            const content = document.getElementById('analysisContent');
            
            if (allUnits.length === 0) {
                content.innerHTML = '<p class="text-center text-sm" style="color: var(--gray);">Nėra duomenų analizei</p>';
                return;
            }
            
            allUnits.forEach(unit => calculateUnit(unit));
            calculatePriorities(allUnits);
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">';
            
            // By staff type analysis
            const byStaffType = {
                'Gydytojai': [],
                'Slaugytojai': [],
                'Padėjėjai': []
            };
            
            allUnits.forEach(unit => {
                if (byStaffType[unit.staffType]) {
                    byStaffType[unit.staffType].push(unit);
                }
            });
            
            Object.entries(byStaffType).forEach(([type, units]) => {
                if (units.length > 0) {
                    const totalBeds = units.reduce((sum, u) => sum + (u.beds || 0), 0);
                    const totalRequired = units.reduce((sum, u) => sum + u.totalRequired, 0);
                    const totalCurrent = units.reduce((sum, u) => sum + u.currentFTE, 0);
                    const gap = totalCurrent - totalRequired;
                    const isZeroGap = isZeroValue(gap);
                    
                    // Use staff type color for the card border
                    const staffColor = STAFF_TYPES[type]?.color || '#3b82f6';
                    
                    html += `
                        <div class="analysis-card" style="border-left: 3px solid ${staffColor};">
                            <h3>${STAFF_TYPES[type]?.icon || '👥'} ${type}</h3>
                            <p><strong>Skyriai:</strong> ${units.length}</p>
                            <p><strong>Lovos:</strong> ${totalBeds}</p>
                            <p><strong>Reikia:</strong> ${formatNumber(totalRequired)}</p>
                            <p><strong>Esami:</strong> ${formatNumber(totalCurrent)}</p>
                            <p><strong>Balansas:</strong> 
                                <span style="color: ${isZeroGap ? 'var(--gap-zero)' : (gap < 0 ? 'var(--gap-shortage)' : 'var(--gap-surplus)')}; font-weight: 600;">
                                    ${isZeroGap ? '0.000' : (gap >= 0 ? '+' : '') + formatNumber(gap)}
                                </span>
                            </p>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        // ==============================================
        // EXPORT FUNCTIONS
        // ==============================================
        
        function exportCSV() {
            let csv = 'ITU Personalo Ataskaita v6.1\n';
            csv += `Data: ${new Date().toLocaleString('lt-LT')}\n\n`;
            
            csv += 'PAGRINDINIAI ITS SKYRIAI\n';
            csv += 'Skyrius,Pareigos,Lovos,Postai,Pamaina,Etatai postui,Papildomi et.,Reikia,Rankinis,Esami,Planas,Liepa,Skirtumas,Skirtumas %,Prioritetas,Kritinis\n';
            
            mainUnits.forEach(unit => {
                calculateUnit(unit);
                const baseFTE = FTE_STANDARDS[unit.shiftType] || 5.250;
                csv += `${unit.name},${unit.staffType},${unit.beds || 0},${unit.stations},${unit.shiftType},${formatNumber(baseFTE)},`;
                csv += `${formatNumber(unit.additionalFTE)},${formatNumber(unit.totalRequired)},`;
                csv += `${unit.isManualRequired ? 'Taip' : 'Ne'},`;
                csv += `${formatNumber(unit.currentFTE)},${formatNumber(unit.nearFutureFTE || unit.currentFTE)},`;
                csv += `${formatNumber(unit.afterJulyFTE || unit.nearFutureFTE || unit.currentFTE)},`;
                csv += `${formatNumber(unit.gap)},${formatPercentage(unit.gapPercentage)},`;
                csv += `${unit.priority || '-'},${unit.isCritical ? 'Taip' : 'Ne'}\n`;
            });
            
            csv += '\nSPECIALIZUOTI SKYRIAI\n';
            csv += 'Skyrius,Pareigos,Lovos,Postai,Pamaina,Etatai postui,Papildomi et.,Reikia,Rankinis,Esami,Planas,Liepa,Skirtumas,Skirtumas %,Prioritetas,Kritinis\n';
            
            specUnits.forEach(unit => {
                calculateUnit(unit);
                const baseFTE = FTE_STANDARDS[unit.shiftType] || 5.250;
                csv += `${unit.name},${unit.staffType},${unit.beds || 0},${unit.stations},${unit.shiftType},${formatNumber(baseFTE)},`;
                csv += `${formatNumber(unit.additionalFTE)},${formatNumber(unit.totalRequired)},`;
                csv += `${unit.isManualRequired ? 'Taip' : 'Ne'},`;
                csv += `${formatNumber(unit.currentFTE)},${formatNumber(unit.nearFutureFTE || unit.currentFTE)},`;
                csv += `${formatNumber(unit.afterJulyFTE || unit.nearFutureFTE || unit.currentFTE)},`;
                csv += `${formatNumber(unit.gap)},${formatPercentage(unit.gapPercentage)},`;
                csv += `${unit.priority || '-'},${unit.isCritical ? 'Taip' : 'Ne'}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ITU_personalo_ataskaita_v6.1_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('📊 CSV ataskaita eksportuota', 'success');
        }

        function exportReport() {
            let report = `ITU PERSONALO PLANAVIMO ATASKAITA v6.1\n`;
            report += `Sugeneruota: ${new Date().toLocaleString('lt-LT')}\n`;
            report += `${'='.repeat(60)}\n\n`;
            
            const allUnits = [...mainUnits, ...specUnits];
            allUnits.forEach(unit => calculateUnit(unit));
            
            // Group by staff type
            const byType = { 'Gydytojai': [], 'Slaugytojai': [], 'Padėjėjai': [] };
            allUnits.forEach(unit => {
                if (byType[unit.staffType]) byType[unit.staffType].push(unit);
            });
            
            Object.entries(byType).forEach(([type, units]) => {
                if (units.length > 0) {
                    report += `\n${type.toUpperCase()}\n`;
                    report += `${'-'.repeat(50)}\n`;
                    
                    units.forEach(unit => {
                        report += `${unit.name}:\n`;
                        report += `   Lovos: ${unit.beds || 0}, Postai: ${unit.stations}, Pamaina: ${unit.shiftType}\n`;
                        report += `   Reikalingi etatai: ${formatNumber(unit.totalRequired)} ${unit.isManualRequired ? '(Rankinis)' : '(Automatinis)'}\n`;
                        report += `   Esami etatai: ${formatNumber(unit.currentFTE)}\n`;
                        report += `   Skirtumas: ${formatNumber(unit.gap)} (${formatPercentage(unit.gapPercentage)})\n`;
                        report += `   Planavimas: ${formatNumber(unit.nearFutureFTE || unit.currentFTE)} → ${formatNumber(unit.afterJulyFTE || unit.nearFutureFTE || unit.currentFTE)}\n\n`;
                    });
                }
            });
            
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ITU_planavimo_ataskaita_v6.1_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('📋 Detalus raportas eksportuotas', 'success');
        }

        function saveConfig() {
            const config = {
                version: '6.1',
                timestamp: new Date().toISOString(),
                mainUnits: mainUnits,
                specUnits: specUnits
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ITU_konfiguracija_v6.1_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('💾 Konfigūracija išsaugota', 'success');
        }

        function loadConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const config = JSON.parse(event.target.result);
                        
                        if (config.mainUnits) mainUnits = config.mainUnits;
                        if (config.specUnits) specUnits = config.specUnits;
                        
                        updateAll();
                        showToast('📂 Konfigūracija įkelta sėkmingai', 'success');
                    } catch (error) {
                        showToast('❌ Klaida įkeliant konfigūraciją', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function printReport() {
            window.print();
        }

        // ==============================================
        // MAIN UPDATE FUNCTION
        // ==============================================
        
        function updateAll() {
            renderUnitsTable(mainUnits, 'mainUnitsBody', 'main');
            renderUnitsTable(specUnits, 'specUnitsBody', 'spec');
            updateDashboard();
        }

        // ==============================================
        // INITIALIZATION
        // ==============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            updateAll();
            showToast('🚀 ITU Personalo Skaičiuoklė v6.1 - Optimizuota lovų bazės sistema!', 'success');
        });

        // Run immediately if DOM is already loaded
        if (document.readyState !== 'loading') {
            updateAll();
        }
    </script>
</body>
</html>
