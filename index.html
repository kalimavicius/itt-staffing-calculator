<!DOCTYPE html>
<html lang="lt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ITU Personalo Skaiƒçiuoklƒó v5.1 - Tikslus personalo planavimas</title>
    <style>
        /* Modern CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --dark: #1e293b;
            --gray: #64748b;
            --light-gray: #f1f5f9;
            --white: #ffffff;
            --border: #e2e8f0;
            
            /* Staff type colors */
            --doctor-color: #3b82f6;
            --nurse-color: #8b5cf6;
            --assistant-color: #f97316;
            
            /* Gap colors - new scheme */
            --gap-zero: #10b981;
            --gap-shortage: #3b82f6;
            --gap-surplus: #ef4444;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: headerPulse 15s ease-in-out infinite;
        }

        @keyframes headerPulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.05); }
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .header .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .version-badge {
            display: inline-block;
            background: var(--success);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-left: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Dashboard Styles */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
            border-radius: 12px 12px 0 0;
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.8;
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }

        .stat-value.zero { color: var(--gap-zero); }
        .stat-value.shortage { color: var(--gap-shortage); }
        .stat-value.surplus { color: var(--gap-surplus); }
        .stat-value.warning { color: var(--warning); }

        /* Tab Styles */
        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 2rem;
            background: var(--white);
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--gray);
        }

        .tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
        }

        .tab:hover:not(.active) {
            background: var(--light-gray);
            color: var(--dark);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Calculator Section Styles */
        .calculator-section {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn-primary { 
            background: var(--primary); 
            color: white; 
        }
        .btn-primary:hover { 
            background: var(--primary-hover); 
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }

        .btn-success { 
            background: var(--success); 
            color: white; 
        }
        .btn-success:hover { 
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
        }

        .btn-warning { 
            background: var(--warning); 
            color: white; 
        }

        .btn-danger { 
            background: var(--danger); 
            color: white; 
        }

        .btn-secondary { 
            background: var(--light-gray); 
            color: var(--dark); 
            border: 1px solid var(--border);
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            background: var(--white);
        }

        th, td {
            padding: 0.75rem 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--light-gray);
            font-weight: 600;
            color: var(--dark);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8fafc;
        }

        .totals-row {
            background: var(--light-gray) !important;
            font-weight: 700;
            border-top: 2px solid var(--primary);
        }

        /* Input Styles */
        input, select {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            width: 100%;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        input[type="number"] {
            text-align: center;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        /* Staff Type Styling */
        .staff-type-doctor {
            background: rgba(59, 130, 246, 0.1) !important;
            border-left: 4px solid var(--doctor-color) !important;
        }

        .staff-type-nurse {
            background: rgba(139, 92, 246, 0.1) !important;
            border-left: 4px solid var(--nurse-color) !important;
        }

        .staff-type-assistant {
            background: rgba(249, 115, 22, 0.1) !important;
            border-left: 4px solid var(--assistant-color) !important;
        }

        /* Required Field Styling */
        .required-cell {
            position: relative;
            padding: 0 !important;
        }

        .required-value {
            width: 100%;
            text-align: center;
            font-weight: 600;
            padding: 0.75rem 0.5rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .required-value.calculated {
            background: rgba(251, 191, 36, 0.1);
            border-color: rgba(251, 191, 36, 0.3);
            color: #d97706;
        }

        .required-value.manual {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.3);
            color: #7c3aed;
        }

        .required-value:hover {
            background: rgba(37, 99, 235, 0.1);
            border-color: var(--primary);
        }

        .manual-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--nurse-color);
            color: white;
            font-size: 0.6rem;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 700;
        }

        /* Gap Badge Styles */
        .gap-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.8rem;
            text-align: center;
        }

        .gap-zero {
            background: rgba(16, 185, 129, 0.1);
            color: var(--gap-zero);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .gap-shortage {
            background: rgba(59, 130, 246, 0.1);
            color: var(--gap-shortage);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .gap-surplus {
            background: rgba(239, 68, 68, 0.1);
            color: var(--gap-surplus);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Priority Badge */
        .priority-badge {
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            background: var(--warning);
            color: white;
        }

        /* Chart Section */
        .chart-section {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .chart-container {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .section-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .quick-actions {
                justify-content: center;
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.info {
            border-left: 4px solid var(--info);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Planning Input Styling */
        .planning-input {
            background: rgba(16, 185, 129, 0.05) !important;
            border-color: rgba(16, 185, 129, 0.3) !important;
        }

        .planning-input:focus {
            border-color: var(--success) !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1) !important;
        }

        /* Export Section */
        .export-section {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            padding: 2rem;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }

        /* Help Section */
        .help-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow-sm);
        }

        .help-card h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .help-card ul {
            color: var(--gray);
            margin-left: 1.5rem;
            line-height: 1.8;
        }

        .help-card li {
            margin: 0.5rem 0;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ITU Personalo Skaiƒçiuoklƒó <span class="version-badge">v5.1</span></h1>
            <p class="subtitle">Pa≈æangus intensyviosios terapijos personalo planavimo ƒØrankis su 3 skaitmen≈≥ tikslumu</p>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
            <div class="stat-card">
                <div class="stat-icon">üè•</div>
                <div class="stat-label">I≈° viso skyri≈≥</div>
                <div class="stat-value" id="totalUnits">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üë®‚Äç‚öïÔ∏è</div>
                <div class="stat-label">Gydytoj≈≥ etatai</div>
                <div class="stat-value" id="doctorFTE">0.000</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üë©‚Äç‚öïÔ∏è</div>
                <div class="stat-label">Slaugytoj≈≥ etatai</div>
                <div class="stat-value" id="nurseFTE">0.000</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ü§ù</div>
                <div class="stat-label">Padƒójƒój≈≥ etatai</div>
                <div class="stat-value" id="assistantFTE">0.000</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üéØ</div>
                <div class="stat-label">Reikalingi etatai</div>
                <div class="stat-value" id="totalRequired">0.000</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-label">Dabartiniai etatai</div>
                <div class="stat-value" id="totalCurrent">0.000</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚öñÔ∏è</div>
                <div class="stat-label">Balansas</div>
                <div class="stat-value" id="totalBalance">0.000</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚ö†Ô∏è</div>
                <div class="stat-label">Skyriai su tr≈´kumu</div>
                <div class="stat-value warning" id="shortageUnits">0</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('calculator')">üìä Skaiƒçiuoklƒó</button>
            <button class="tab" onclick="switchTab('analysis')">üìà Analizƒó</button>
            <button class="tab" onclick="switchTab('help')">‚ùì Pagalba</button>
        </div>

        <!-- Calculator Tab -->
        <div id="calculator-tab" class="tab-content active">
            <!-- Main Units Section -->
            <div class="calculator-section">
                <div class="section-header">
                    <div class="section-title">
                        <span style="font-size: 1.5em;">üè•</span>
                        Pagrindiniai ITS skyriai
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-success btn-sm" onclick="addMainUnit()">‚ûï Pridƒóti</button>
                        <button class="btn btn-danger btn-sm" onclick="removeMainUnit()">‚ûñ ≈†alinti</button>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="btn btn-secondary btn-sm" onclick="resetMainDefaults()">üîÑ Atkurti</button>
                    <button class="btn btn-secondary btn-sm" onclick="clearMainAdditional()">üßπ Valyti papild.</button>
                    <button class="btn btn-secondary btn-sm" onclick="clearMainManual()">üî¢ Valyti rankinius</button>
                    <button class="btn btn-secondary btn-sm" onclick="autoConfigureMain()">ü§ñ Auto konfig.</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Skyrius</th>
                                <th>Tipas</th>
                                <th>Postai</th>
                                <th>Pamaina</th>
                                <th>Bazƒó FTE</th>
                                <th>Papild. FTE</th>
                                <th>Reikia FTE</th>
                                <th>Turimi FTE</th>
                                <th>Artimi planai</th>
                                <th>Po liepos</th>
                                <th>Skirtumas</th>
                                <th>Gap %</th>
                                <th>Prioritetas</th>
                                <th>Kritinis</th>
                            </tr>
                        </thead>
                        <tbody id="mainUnitsBody"></tbody>
                        <tfoot>
                            <tr class="totals-row">
                                <td><strong>VISO:</strong></td>
                                <td>-</td>
                                <td id="mainTotalStations" class="text-center font-bold">0</td>
                                <td>-</td>
                                <td>-</td>
                                <td id="mainTotalAdditional" class="text-center font-bold">0.000</td>
                                <td id="mainTotalRequired" class="text-center font-bold">0.000</td>
                                <td id="mainTotalCurrent" class="text-center font-bold">0.000</td>
                                <td id="mainTotalNearFuture" class="text-center font-bold">0.000</td>
                                <td id="mainTotalAfterJuly" class="text-center font-bold">0.000</td>
                                <td id="mainTotalGap" class="text-center font-bold">0.000</td>
                                <td id="mainTotalGapPercent" class="text-center font-bold">0.0%</td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Specialized Units Section -->
            <div class="calculator-section">
                <div class="section-header">
                    <div class="section-title">
                        <span style="font-size: 1.5em;">üè¢</span>
                        Specializuoti skyriai
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-success btn-sm" onclick="addSpecUnit()">‚ûï Pridƒóti</button>
                        <button class="btn btn-danger btn-sm" onclick="removeSpecUnit()">‚ûñ ≈†alinti</button>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="btn btn-secondary btn-sm" onclick="resetSpecDefaults()">üîÑ Atkurti</button>
                    <button class="btn btn-secondary btn-sm" onclick="clearSpecAdditional()">üßπ Valyti papild.</button>
                    <button class="btn btn-secondary btn-sm" onclick="clearSpecManual()">üî¢ Valyti rankinius</button>
                    <button class="btn btn-secondary btn-sm" onclick="autoConfigureSpec()">ü§ñ Auto konfig.</button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Skyrius</th>
                                <th>Tipas</th>
                                <th>Postai</th>
                                <th>Pamaina</th>
                                <th>Bazƒó FTE</th>
                                <th>Papild. FTE</th>
                                <th>Reikia FTE</th>
                                <th>Turimi FTE</th>
                                <th>Artimi planai</th>
                                <th>Po liepos</th>
                                <th>Skirtumas</th>
                                <th>Gap %</th>
                                <th>Prioritetas</th>
                                <th>Kritinis</th>
                            </tr>
                        </thead>
                        <tbody id="specUnitsBody"></tbody>
                        <tfoot>
                            <tr class="totals-row">
                                <td><strong>VISO:</strong></td>
                                <td>-</td>
                                <td id="specTotalStations" class="text-center font-bold">0</td>
                                <td>-</td>
                                <td>-</td>
                                <td id="specTotalAdditional" class="text-center font-bold">0.000</td>
                                <td id="specTotalRequired" class="text-center font-bold">0.000</td>
                                <td id="specTotalCurrent" class="text-center font-bold">0.000</td>
                                <td id="specTotalNearFuture" class="text-center font-bold">0.000</td>
                                <td id="specTotalAfterJuly" class="text-center font-bold">0.000</td>
                                <td id="specTotalGap" class="text-center font-bold">0.000</td>
                                <td id="specTotalGapPercent" class="text-center font-bold">0.0%</td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis-tab" class="tab-content">
            <div class="chart-section">
                <h2 style="color: var(--primary); margin-bottom: 1rem;">üìä Personalo analizƒó</h2>
                <div class="chart-container">
                    <canvas id="staffChart" width="800" height="400"></canvas>
                </div>
            </div>

            <div class="calculator-section">
                <div class="section-title mb-4">üìà Personalo statistikos</div>
                <div id="analysisContent">
                    <p class="text-center text-sm" style="color: var(--gray);">Statistikos duomenys bus rodomi ƒçia po skaiƒçiavim≈≥...</p>
                </div>
            </div>
        </div>

        <!-- Help Tab -->
        <div id="help-tab" class="tab-content">
            <div class="help-card">
                <h3>üéØ Reikia FTE laukas - Pagrindinƒó funkcija</h3>
                <ul>
                    <li><strong>Automatinis skaiƒçiavimas:</strong> REIKIA = (Postai √ó Bazƒó FTE) + Papild. FTE</li>
                    <li><strong>Rankinis koregavimas:</strong> Spustelƒókite REIKIA laukƒÖ norƒódami ƒØvesti savo reik≈°mƒô</li>
                    <li><strong style="color: #d97706;">Geltona spalva:</strong> Automati≈°kai apskaiƒçiuota reik≈°mƒó</li>
                    <li><strong style="color: #7c3aed;">Violetinƒó spalva:</strong> Rankiniu b≈´du ƒØvesta reik≈°mƒó (≈æymima "M")</li>
                    <li>Visos analizƒós naudoja REIKIA reik≈°mƒô skaiƒçiavimams</li>
                </ul>
            </div>

            <div class="help-card">
                <h3>üé® Spalv≈≥ kodavimo sistema</h3>
                <ul>
                    <li><strong style="color: var(--gap-zero);">≈Ωalia spalva:</strong> Tobulas balansas (0.000 skirtumas)</li>
                    <li><strong style="color: var(--gap-shortage);">Mƒólyna spalva:</strong> Personalo tr≈´kumas (neigiamas skirtumas)</li>
                    <li><strong style="color: var(--gap-surplus);">Raudona spalva:</strong> Personalo perteklius (teigiamas skirtumas)</li>
                </ul>
            </div>

            <div class="help-card">
                <h3>üë• Personalo tip≈≥ klasifikacija</h3>
                <ul>
                    <li><strong style="color: var(--doctor-color);">Gydytojai:</strong> Medicininis personalas (gydytojai anesteziologai reanimatologai)</li>
                    <li><strong style="color: var(--nurse-color);">Slaugytojai:</strong> Anestezijos ir intensyviosios terapijos slaugytojai</li>
                    <li><strong style="color: var(--assistant-color);">Padƒójƒójai:</strong> Slaugytoj≈≥ padƒójƒójai</li>
                </ul>
            </div>

            <div class="help-card">
                <h3>üî¢ Skaiƒçiavimo metodika (3 skaitmen≈≥ tikslumas)</h3>
                <ul>
                    <li><strong>Bazinio FTE formulƒó:</strong> Pamain≈≥ valandos √ó 7 dien≈≥ √∑ 40 val/sav √ó 1.25</li>
                    <li><strong>24/7 pamainos:</strong> (24h √ó 7d) √∑ 40h √ó 1.25 = 5.250 FTE/postui</li>
                    <li><strong>12/7 pamainos:</strong> (12h √ó 7d) √∑ 40h √ó 1.25 = 2.625 FTE/postui</li>
                    <li><strong>12/6 pamainos:</strong> (12h √ó 6d) √∑ 40h √ó 1.25 = 2.250 FTE/postui</li>
                    <li><strong>Visi skaiƒçiavimai:</strong> 3 skaitmen≈≥ po kablelio tikslumas</li>
                </ul>
            </div>

            <div class="help-card">
                <h3>üìã Reguliavimo pagrindas</h3>
                <ul>
                    <li><strong>Teisinis pagrindas:</strong> LR SAM ƒØsakymas Nr. V-465 (2022-03-02)</li>
                    <li><strong>Pakeitim≈≥ ƒØsakymas:</strong> Nr. V-1213 (2024-12-03)</li>
                    <li><strong>17 punktas:</strong> Personalo normatyv≈≥ reikalavimai</li>
                    <li><strong>X skyrius:</strong> Papildomo mokƒójimo tvarka</li>
                </ul>
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <button class="btn btn-primary" onclick="exportCSV()">üìä Eksportuoti CSV</button>
            <button class="btn btn-success" onclick="exportReport()">üìã Detalus raportas</button>
            <button class="btn btn-secondary" onclick="saveConfig()">üíæ I≈°saugoti konfig≈´racijƒÖ</button>
            <button class="btn btn-secondary" onclick="loadConfig()">üìÇ ƒÆkelti konfig≈´racijƒÖ</button>
            <button class="btn btn-secondary" onclick="printReport()">üñ®Ô∏è Spausdinti</button>
        </div>
    </div>

    <script>
        // ==============================================
        // CONSTANTS AND CONFIGURATION
        // ==============================================
        
        const FTE_STANDARDS = {
            '24/7': 5.250,
            '12/7': 2.625,
            '12/6': 2.250,
            '12/5': 1.875,
            '10/6': 1.875,
            '8/5': 1.250
        };

        const STAFF_TYPES = {
            'Gydytojai': { color: '#3b82f6', icon: 'üë®‚Äç‚öïÔ∏è' },
            'Slaugytojai': { color: '#8b5cf6', icon: 'üë©‚Äç‚öïÔ∏è' },
            'Padƒójƒójai': { color: '#f97316', icon: 'ü§ù' }
        };

        const PRECISION = 3; // 3 decimal places

        // ==============================================
        // STATE MANAGEMENT
        // ==============================================
        
        let mainUnits = [
            { 
                name: 'I ITS', 
                staffType: 'Gydytojai', 
                stations: 3, 
                shiftType: '24/7', 
                additionalFTE: 1.000, 
                manualRequired: null,
                currentFTE: 18.000, 
                nearFutureFTE: 18.500, 
                afterJulyFTE: 20.000, 
                isCritical: false 
            },
            { 
                name: 'II ITS', 
                staffType: 'Slaugytojai', 
                stations: 3, 
                shiftType: '24/7', 
                additionalFTE: 1.000,
                manualRequired: null,
                currentFTE: 15.125, 
                nearFutureFTE: 16.000, 
                afterJulyFTE: 17.500, 
                isCritical: false 
            },
            { 
                name: 'III ITS', 
                staffType: 'Gydytojai', 
                stations: 2, 
                shiftType: '24/7', 
                additionalFTE: 0.750,
                manualRequired: null,
                currentFTE: 11.750, 
                nearFutureFTE: 11.750, 
                afterJulyFTE: 12.500, 
                isCritical: false 
            },
            { 
                name: 'IV ITS', 
                staffType: 'Padƒójƒójai', 
                stations: 1, 
                shiftType: '24/7', 
                additionalFTE: 0.250,
                manualRequired: null,
                currentFTE: 5.500, 
                nearFutureFTE: 5.500, 
                afterJulyFTE: 6.000, 
                isCritical: false 
            }
        ];

        let specUnits = [
            { 
                name: 'PTP', 
                staffType: 'Gydytojai', 
                stations: 1, 
                shiftType: '12/6', 
                additionalFTE: 0.250,
                manualRequired: null,
                currentFTE: 3.000, 
                nearFutureFTE: 3.000, 
                afterJulyFTE: 3.500, 
                isCritical: false 
            },
            { 
                name: 'RDPKP', 
                staffType: 'Slaugytojai', 
                stations: 1, 
                shiftType: '12/6', 
                additionalFTE: 0.000,
                manualRequired: null,
                currentFTE: 2.000, 
                nearFutureFTE: 2.250, 
                afterJulyFTE: 2.500, 
                isCritical: false 
            }
        ];

        // ==============================================
        // UTILITY FUNCTIONS
        // ==============================================
        
        function formatNumber(value, decimals = PRECISION) {
            if (value === null || value === undefined || isNaN(value)) return '0.' + '0'.repeat(decimals);
            return Number(value).toFixed(decimals);
        }

        function formatPercentage(value, decimals = 1) {
            if (value === null || value === undefined || isNaN(value)) return '0.0%';
            return Number(value).toFixed(decimals) + '%';
        }

        function isZeroValue(value, threshold = 0.001) {
            return Math.abs(value) < threshold;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = { 
                success: '‚úÖ', 
                error: '‚ùå', 
                warning: '‚ö†Ô∏è', 
                info: '‚ÑπÔ∏è' 
            };
            
            toast.innerHTML = `${icons[type] || 'üìÑ'} ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // ==============================================
        // CALCULATION FUNCTIONS
        // ==============================================
        
        function calculateUnit(unit) {
            const baseFTEPerStation = FTE_STANDARDS[unit.shiftType] || 5.250;
            unit.baseRequired = unit.stations * baseFTEPerStation;
            
            // Calculate total required FTE
            const calculatedRequired = unit.baseRequired + (unit.additionalFTE || 0);
            unit.totalRequired = unit.manualRequired !== null ? unit.manualRequired : calculatedRequired;
            unit.isManualRequired = unit.manualRequired !== null;
            
            // Calculate gaps and metrics
            unit.gap = unit.currentFTE - unit.totalRequired;
            unit.gapPercentage = unit.totalRequired > 0 ? (unit.gap / unit.totalRequired) * 100 : 0;
            
            // Priority calculation
            const weightFactor = unit.isCritical ? 1.5 : 1.0;
            unit.priorityScore = Math.abs(unit.gapPercentage) * weightFactor;
            
            // Future planning gaps
            unit.nearFutureGap = (unit.nearFutureFTE || unit.currentFTE) - unit.totalRequired;
            unit.afterJulyGap = (unit.afterJulyFTE || unit.nearFutureFTE || unit.currentFTE) - unit.totalRequired;
            
            return unit;
        }

        function calculatePriorities(units) {
            // Reset priorities
            units.forEach(unit => unit.priority = null);
            
            // Find units with shortages
            const unitsWithShortages = units.filter(u => u.gap < -0.001);
            
            if (unitsWithShortages.length > 0) {
                // Sort by priority score (descending)
                const sortedShortages = [...unitsWithShortages].sort((a, b) => b.priorityScore - a.priorityScore);
                
                // Assign priorities
                sortedShortages.forEach((sortedUnit, index) => {
                    const originalUnit = units.find(u => u === sortedUnit);
                    if (originalUnit) originalUnit.priority = index + 1;
                });
            }
        }

        // ==============================================
        // TAB MANAGEMENT
        // ==============================================
        
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Special handling for analysis tab
            if (tabName === 'analysis') {
                setTimeout(() => {
                    drawChart();
                    updateAnalysisContent();
                }, 100);
            }
        }

        // ==============================================
        // MANUAL REQUIRED FIELD TOGGLE
        // ==============================================
        
        function toggleRequiredField(prefix, index) {
            const units = prefix === 'main' ? mainUnits : specUnits;
            const unit = units[index];
            
            if (unit.manualRequired === null) {
                // Switch to manual mode
                const calculatedValue = unit.baseRequired + (unit.additionalFTE || 0);
                const newValue = prompt('ƒÆveskite reikalingus FTE:', calculatedValue.toFixed(PRECISION));
                
                if (newValue !== null && !isNaN(parseFloat(newValue))) {
                    unit.manualRequired = parseFloat(newValue);
                    updateAll();
                    showToast('üî¢ Perjungta ƒØ rankinƒØ re≈æimƒÖ', 'info');
                }
            } else {
                // Switch back to calculated mode
                if (confirm('GrƒØ≈æti ƒØ automatinƒØ skaiƒçiavimƒÖ?')) {
                    unit.manualRequired = null;
                    updateAll();
                    showToast('üîÑ GrƒØ≈æta ƒØ automatinƒØ skaiƒçiavimƒÖ', 'success');
                }
            }
        }

        // ==============================================
        // TABLE RENDERING
        // ==============================================
        
        function renderUnitsTable(units, bodyId, prefix) {
            const tbody = document.getElementById(bodyId);
            tbody.innerHTML = '';
            
            let totalStations = 0;
            let totalAdditional = 0;
            let totalRequired = 0;
            let totalCurrent = 0;
            let totalNearFuture = 0;
            let totalAfterJuly = 0;
            
            // Calculate all units and priorities
            units.forEach(unit => calculateUnit(unit));
            calculatePriorities(units);
            
            // Render each unit
            units.forEach((unit, index) => {
                const baseFTEPerStation = FTE_STANDARDS[unit.shiftType] || 5.250;
                const isZeroGap = isZeroValue(unit.gap);
                const isShortage = unit.gap < -0.001;
                const isSurplus = unit.gap > 0.001;
                
                // Determine gap styling
                let gapClass = 'gap-zero';
                if (isShortage) gapClass = 'gap-shortage';
                else if (isSurplus) gapClass = 'gap-surplus';
                
                // Determine staff type class
                let staffTypeClass = '';
                if (unit.staffType === 'Gydytojai') staffTypeClass = 'staff-type-doctor';
                else if (unit.staffType === 'Slaugytojai') staffTypeClass = 'staff-type-nurse';
                else if (unit.staffType === 'Padƒójƒójai') staffTypeClass = 'staff-type-assistant';
                
                const row = tbody.insertRow();
                row.className = staffTypeClass;
                
                row.innerHTML = `
                    <td>
                        <input type="text" value="${unit.name}" onchange="updateUnit('${prefix}', ${index}, 'name', this.value)" style="border: none; background: transparent; font-weight: 600;">
                    </td>
                    <td>
                        <select onchange="updateUnit('${prefix}', ${index}, 'staffType', this.value)" style="border: none; background: transparent;">
                            <option value="Gydytojai" ${unit.staffType === 'Gydytojai' ? 'selected' : ''}>Gydytojai</option>
                            <option value="Slaugytojai" ${unit.staffType === 'Slaugytojai' ? 'selected' : ''}>Slaugytojai</option>
                            <option value="Padƒójƒójai" ${unit.staffType === 'Padƒójƒójai' ? 'selected' : ''}>Padƒójƒójai</option>
                        </select>
                    </td>
                    <td class="text-center">
                        <input type="number" value="${unit.stations}" min="0" step="1" onchange="updateUnit('${prefix}', ${index}, 'stations', this.value)" style="border: none; background: transparent; text-align: center;">
                    </td>
                    <td class="text-center">
                        <select onchange="updateUnit('${prefix}', ${index}, 'shiftType', this.value)" style="border: none; background: transparent;">
                            ${Object.keys(FTE_STANDARDS).map(pattern => 
                                `<option value="${pattern}" ${unit.shiftType === pattern ? 'selected' : ''}>${pattern}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td class="text-center" style="color: var(--info); font-weight: 600;">
                        ${formatNumber(baseFTEPerStation)}
                    </td>
                    <td class="text-center">
                        <input type="number" value="${formatNumber(unit.additionalFTE)}" step="0.001" min="0" onchange="updateUnit('${prefix}', ${index}, 'additionalFTE', this.value)" style="border: none; background: transparent; text-align: center;">
                    </td>
                    <td class="required-cell">
                        <div class="required-value ${unit.isManualRequired ? 'manual' : 'calculated'}" 
                             onclick="toggleRequiredField('${prefix}', ${index})"
                             title="${unit.isManualRequired ? 'Rankinis ƒØvedimas - spustelƒókite keisti' : 'Automatinis skaiƒçiavimas - spustelƒókite redaguoti'}">
                            ${formatNumber(unit.totalRequired)}
                            ${unit.isManualRequired ? '<span class="manual-indicator">M</span>' : ''}
                        </div>
                    </td>
                    <td class="text-center">
                        <input type="number" value="${formatNumber(unit.currentFTE)}" step="0.001" min="0" onchange="updateUnit('${prefix}', ${index}, 'currentFTE', this.value)" style="border: none; background: transparent; text-align: center;">
                    </td>
                    <td class="text-center">
                        <input type="number" value="${formatNumber(unit.nearFutureFTE || unit.currentFTE)}" step="0.001" min="0" class="planning-input" onchange="updateUnit('${prefix}', ${index}, 'nearFutureFTE', this.value)" style="text-align: center;">
                    </td>
                    <td class="text-center">
                        <input type="number" value="${formatNumber(unit.afterJulyFTE || unit.nearFutureFTE || unit.currentFTE)}" step="0.001" min="0" class="planning-input" onchange="updateUnit('${prefix}', ${index}, 'afterJulyFTE', this.value)" style="text-align: center;">
                    </td>
                    <td class="text-center">
                        <span class="gap-badge ${gapClass}">
                            ${isZeroGap ? '0.000' : (unit.gap >= 0 ? '+' : '') + formatNumber(unit.gap)}
                        </span>
                    </td>
                    <td class="text-center" style="color: ${isZeroGap ? 'var(--gap-zero)' : (isShortage ? 'var(--gap-shortage)' : 'var(--gap-surplus)')}; font-weight: 600;">
                        ${isZeroGap ? '0.0%' : (unit.gapPercentage >= 0 ? '+' : '') + formatPercentage(unit.gapPercentage)}
                    </td>
                    <td class="text-center">
                        ${unit.priority ? `<span class="priority-badge">#${unit.priority}</span>` : '-'}
                    </td>
                    <td class="text-center">
                        <input type="checkbox" ${unit.isCritical ? 'checked' : ''} onchange="updateUnit('${prefix}', ${index}, 'isCritical', this.checked)">
                    </td>
                `;
                
                // Update totals
                totalStations += unit.stations;
                totalAdditional += unit.additionalFTE || 0;
                totalRequired += unit.totalRequired;
                totalCurrent += unit.currentFTE;
                totalNearFuture += unit.nearFutureFTE || unit.currentFTE;
                totalAfterJuly += unit.afterJulyFTE || unit.nearFutureFTE || unit.currentFTE;
            });
            
            // Update totals display
            const totalGap = totalCurrent - totalRequired;
            const totalGapPercent = totalRequired > 0 ? (totalGap / totalRequired) * 100 : 0;
            const isZeroTotalGap = isZeroValue(totalGap);
            
            document.getElementById(`${prefix}TotalStations`).textContent = totalStations;
            document.getElementById(`${prefix}TotalAdditional`).textContent = formatNumber(totalAdditional);
            document.getElementById(`${prefix}TotalRequired`).textContent = formatNumber(totalRequired);
            document.getElementById(`${prefix}TotalCurrent`).textContent = formatNumber(totalCurrent);
            document.getElementById(`${prefix}TotalNearFuture`).textContent = formatNumber(totalNearFuture);
            document.getElementById(`${prefix}TotalAfterJuly`).textContent = formatNumber(totalAfterJuly);
            
            const gapEl = document.getElementById(`${prefix}TotalGap`);
            gapEl.textContent = isZeroTotalGap ? '0.000' : (totalGap >= 0 ? '+' : '') + formatNumber(totalGap);
            gapEl.style.color = isZeroTotalGap ? 'var(--gap-zero)' : (totalGap < 0 ? 'var(--gap-shortage)' : 'var(--gap-surplus)');
            
            const gapPercentEl = document.getElementById(`${prefix}TotalGapPercent`);
            gapPercentEl.textContent = isZeroTotalGap ? '0.0%' : (totalGapPercent >= 0 ? '+' : '') + formatPercentage(totalGapPercent);
            gapPercentEl.style.color = isZeroTotalGap ? 'var(--gap-zero)' : (totalGapPercent < 0 ? 'var(--gap-shortage)' : 'var(--gap-surplus)');
        }

        // ==============================================
        // DASHBOARD UPDATE
        // ==============================================
        
        function updateDashboard() {
            const allUnits = [...mainUnits, ...specUnits];
            
            let totalStations = 0;
            let totalRequired = 0;
            let totalCurrent = 0;
            let shortageCount = 0;
            let doctorFTE = 0;
            let nurseFTE = 0;
            let assistantFTE = 0;
            
            allUnits.forEach(unit => {
                calculateUnit(unit);
                totalStations += unit.stations;
                totalRequired += unit.totalRequired;
                totalCurrent += unit.currentFTE;
                
                if (unit.gap < -0.001) shortageCount++;
                
                // Count by staff type
                if (unit.staffType === 'Gydytojai') doctorFTE += unit.currentFTE;
                else if (unit.staffType === 'Slaugytojai') nurseFTE += unit.currentFTE;
                else if (unit.staffType === 'Padƒójƒójai') assistantFTE += unit.currentFTE;
            });
            
            const currentBalance = totalCurrent - totalRequired;
            const isZeroBalance = isZeroValue(currentBalance);
            
            document.getElementById('totalUnits').textContent = allUnits.length;
            document.getElementById('doctorFTE').textContent = formatNumber(doctorFTE);
            document.getElementById('nurseFTE').textContent = formatNumber(nurseFTE);
            document.getElementById('assistantFTE').textContent = formatNumber(assistantFTE);
            document.getElementById('totalRequired').textContent = formatNumber(totalRequired);
            document.getElementById('totalCurrent').textContent = formatNumber(totalCurrent);
            document.getElementById('shortageUnits').textContent = shortageCount;
            
            const balanceEl = document.getElementById('totalBalance');
            balanceEl.textContent = isZeroBalance ? '0.000' : (currentBalance >= 0 ? '+' : '') + formatNumber(currentBalance);
            balanceEl.className = `stat-value ${isZeroBalance ? 'zero' : (currentBalance < 0 ? 'shortage' : 'surplus')}`;
        }

        // ==============================================
        // UNIT MANAGEMENT FUNCTIONS
        // ==============================================
        
        function updateUnit(prefix, index, field, value) {
            const units = prefix === 'main' ? mainUnits : specUnits;
            
            if (field === 'name' || field === 'shiftType' || field === 'staffType') {
                units[index][field] = value;
            } else if (field === 'isCritical') {
                units[index][field] = value;
            } else {
                units[index][field] = parseFloat(value) || 0;
            }
            
            updateAll();
        }

        function addMainUnit() {
            const newUnitNumber = mainUnits.length + 1;
            const romanNumerals = ['', 'I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X'];
            
            mainUnits.push({
                name: newUnitNumber <= 10 ? `${romanNumerals[newUnitNumber]} ITS` : `${newUnitNumber} ITS`,
                staffType: 'Gydytojai',
                stations: 1,
                shiftType: '24/7',
                additionalFTE: 0.000,
                manualRequired: null,
                currentFTE: 0.000,
                nearFutureFTE: 0.000,
                afterJulyFTE: 0.000,
                isCritical: false
            });
            updateAll();
            showToast('‚úÖ Pridƒótas naujas pagrindinis skyrius', 'success');
        }

        function removeMainUnit() {
            if (mainUnits.length > 1) {
                mainUnits.pop();
                updateAll();
                showToast('‚ÑπÔ∏è Pa≈°alintas pagrindinis skyrius', 'info');
            } else {
                showToast('‚ö†Ô∏è Negalima pa≈°alinti paskutinio skyriaus', 'warning');
            }
        }

        function addSpecUnit() {
            specUnits.push({
                name: `Spec ${specUnits.length + 1}`,
                staffType: 'Gydytojai',
                stations: 1,
                shiftType: '12/6',
                additionalFTE: 0.000,
                manualRequired: null,
                currentFTE: 0.000,
                nearFutureFTE: 0.000,
                afterJulyFTE: 0.000,
                isCritical: false
            });
            updateAll();
            showToast('‚úÖ Pridƒótas naujas specializuotas skyrius', 'success');
        }

        function removeSpecUnit() {
            if (specUnits.length > 0) {
                specUnits.pop();
                updateAll();
                showToast('‚ÑπÔ∏è Pa≈°alintas specializuotas skyrius', 'info');
            } else {
                showToast('‚ö†Ô∏è Nƒóra skyri≈≥ pa≈°alinimui', 'warning');
            }
        }

        // ==============================================
        // CONFIGURATION FUNCTIONS
        // ==============================================
        
        function resetMainDefaults() {
            if (confirm('Atkurti pagrindini≈≥ skyri≈≥ numatytuosius nustatymus?')) {
                mainUnits = [
                    { name: 'I ITS', staffType: 'Gydytojai', stations: 3, shiftType: '24/7', additionalFTE: 1.000, manualRequired: null, currentFTE: 18.000, nearFutureFTE: 18.500, afterJulyFTE: 20.000, isCritical: false },
                    { name: 'II ITS', staffType: 'Slaugytojai', stations: 3, shiftType: '24/7', additionalFTE: 1.000, manualRequired: null, currentFTE: 15.125, nearFutureFTE: 16.000, afterJulyFTE: 17.500, isCritical: false },
                    { name: 'III ITS', staffType: 'Gydytojai', stations: 2, shiftType: '24/7', additionalFTE: 0.750, manualRequired: null, currentFTE: 11.750, nearFutureFTE: 11.750, afterJulyFTE: 12.500, isCritical: false },
                    { name: 'IV ITS', staffType: 'Padƒójƒójai', stations: 1, shiftType: '24/7', additionalFTE: 0.250, manualRequired: null, currentFTE: 5.500, nearFutureFTE: 5.500, afterJulyFTE: 6.000, isCritical: false }
                ];
                updateAll();
                showToast('üîÑ Atkurti numatytieji nustatymai', 'success');
            }
        }

        function resetSpecDefaults() {
            if (confirm('Atkurti specializuot≈≥ skyri≈≥ numatytuosius nustatymus?')) {
                specUnits = [
                    { name: 'PTP', staffType: 'Gydytojai', stations: 1, shiftType: '12/6', additionalFTE: 0.250, manualRequired: null, currentFTE: 3.000, nearFutureFTE: 3.000, afterJulyFTE: 3.500, isCritical: false },
                    { name: 'RDPKP', staffType: 'Slaugytojai', stations: 1, shiftType: '12/6', additionalFTE: 0.000, manualRequired: null, currentFTE: 2.000, nearFutureFTE: 2.250, afterJulyFTE: 2.500, isCritical: false }
                ];
                updateAll();
                showToast('üîÑ Atkurti numatytieji nustatymai', 'success');
            }
        }

        function clearMainAdditional() {
            mainUnits.forEach(unit => unit.additionalFTE = 0.000);
            updateAll();
            showToast('üßπ I≈°valyti papildomi FTE', 'success');
        }

        function clearSpecAdditional() {
            specUnits.forEach(unit => unit.additionalFTE = 0.000);
            updateAll();
            showToast('üßπ I≈°valyti papildomi FTE', 'success');
        }

        function clearMainManual() {
            mainUnits.forEach(unit => unit.manualRequired = null);
            updateAll();
            showToast('üî¢ I≈°valyti rankiniai REIKIA ƒØvedimai', 'success');
        }

        function clearSpecManual() {
            specUnits.forEach(unit => unit.manualRequired = null);
            updateAll();
            showToast('üî¢ I≈°valyti rankiniai REIKIA ƒØvedimai', 'success');
        }

        function autoConfigureMain() {
            mainUnits.forEach(unit => {
                unit.additionalFTE = Math.max(0, Math.round(unit.stations * 0.333 * 1000) / 1000);
            });
            updateAll();
            showToast('ü§ñ Pagrindiniams skyriams pritaikyta i≈°mani konfig≈´racija', 'success');
        }

        function autoConfigureSpec() {
            specUnits.forEach(unit => {
                unit.additionalFTE = unit.stations > 2 ? 0.500 : 0.250;
            });
            updateAll();
            showToast('ü§ñ Specializuotiems skyriams pritaikyta i≈°mani konfig≈´racija', 'success');
        }

        // ==============================================
        // CHART FUNCTIONS
        // ==============================================
        
        function drawChart() {
            const canvas = document.getElementById('staffChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width = 800;
            const height = canvas.height = 400;
            
            ctx.clearRect(0, 0, width, height);
            
            const allUnits = [...mainUnits, ...specUnits].map(unit => {
                calculateUnit(unit);
                return unit;
            });
            
            if (allUnits.length === 0) return;
            
            // Chart configuration
            const padding = { top: 40, right: 60, bottom: 80, left: 80 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            // Find max value for scale
            let maxValue = 0;
            allUnits.forEach(unit => {
                const max = Math.max(unit.totalRequired, unit.currentFTE, unit.nearFutureFTE || 0, unit.afterJulyFTE || 0);
                if (max > maxValue) maxValue = max;
            });
            maxValue = maxValue * 1.1;
            
            // Draw grid
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding.top + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding.left, y);
                ctx.lineTo(width - padding.right, y);
                ctx.stroke();
                
                ctx.fillStyle = '#64748b';
                ctx.font = '10px sans-serif';
                ctx.textAlign = 'right';
                const value = maxValue - (maxValue / 5) * i;
                ctx.fillText(value.toFixed(1), padding.left - 10, y + 4);
            }
            
            // Draw bars
            const barWidth = chartWidth / allUnits.length / 4;
            const groupWidth = chartWidth / allUnits.length;
            
            allUnits.forEach((unit, index) => {
                const x = padding.left + groupWidth * index + groupWidth / 2;
                const staffColor = STAFF_TYPES[unit.staffType]?.color || '#3b82f6';
                
                // Bar heights
                const currentHeight = (unit.currentFTE / maxValue) * chartHeight;
                const requiredHeight = (unit.totalRequired / maxValue) * chartHeight;
                const nearFutureHeight = ((unit.nearFutureFTE || unit.currentFTE) / maxValue) * chartHeight;
                const afterJulyHeight = ((unit.afterJulyFTE || unit.nearFutureFTE || unit.currentFTE) / maxValue) * chartHeight;
                
                // Draw current FTE bar
                const currentBarX = x - barWidth * 1.5;
                const currentBarY = padding.top + chartHeight - currentHeight;
                
                ctx.fillStyle = staffColor;
                ctx.fillRect(currentBarX, currentBarY, barWidth, currentHeight);
                
                // Draw required line
                ctx.strokeStyle = unit.isManualRequired ? '#8b5cf6' : '#dc2626';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(x - groupWidth * 0.4, padding.top + chartHeight - requiredHeight);
                ctx.lineTo(x + groupWidth * 0.4, padding.top + chartHeight - requiredHeight);
                ctx.stroke();
                ctx.setLineDash([]);
                
                // Future planning bars (lighter colors)
                ctx.fillStyle = staffColor + '80';
                const nearFutureBarX = x - barWidth * 0.5;
                const nearFutureBarY = padding.top + chartHeight - nearFutureHeight;
                ctx.fillRect(nearFutureBarX, nearFutureBarY, barWidth, nearFutureHeight);
                
                ctx.fillStyle = staffColor + '60';
                const afterJulyBarX = x + barWidth * 0.5;
                const afterJulyBarY = padding.top + chartHeight - afterJulyHeight;
                ctx.fillRect(afterJulyBarX, afterJulyBarY, barWidth, afterJulyHeight);
                
                // Unit labels
                ctx.fillStyle = '#1e293b';
                ctx.font = 'bold 11px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(unit.name, x, height - 50);
                
                // Staff type
                ctx.fillStyle = staffColor;
                ctx.font = '9px sans-serif';
                ctx.fillText(unit.staffType, x, height - 35);
                
                // Gap value
                const isZeroGap = isZeroValue(unit.gap);
                ctx.font = 'bold 10px sans-serif';
                if (isZeroGap) {
                    ctx.fillStyle = '#10b981';
                    ctx.fillText('0.000', x, height - 20);
                } else if (unit.gap < 0) {
                    ctx.fillStyle = '#3b82f6';
                    ctx.fillText(unit.gap.toFixed(3), x, height - 20);
                } else {
                    ctx.fillStyle = '#ef4444';
                    ctx.fillText(`+${unit.gap.toFixed(3)}`, x, height - 20);
                }
            });
            
            // Chart title
            ctx.fillStyle = '#1e293b';
            ctx.font = 'bold 14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Personalo analizƒó pagal skyrius', width / 2, 25);
            
            // Y-axis label
            ctx.save();
            ctx.translate(20, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.font = '12px sans-serif';
            ctx.fillStyle = '#64748b';
            ctx.textAlign = 'center';
            ctx.fillText('FTE', 0, 0);
            ctx.restore();
        }

        function updateAnalysisContent() {
            const allUnits = [...mainUnits, ...specUnits];
            const content = document.getElementById('analysisContent');
            
            if (allUnits.length === 0) {
                content.innerHTML = '<p class="text-center text-sm" style="color: var(--gray);">Nƒóra duomen≈≥ analizei</p>';
                return;
            }
            
            allUnits.forEach(unit => calculateUnit(unit));
            calculatePriorities(allUnits);
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">';
            
            // By staff type analysis
            const byStaffType = {
                'Gydytojai': [],
                'Slaugytojai': [],
                'Padƒójƒójai': []
            };
            
            allUnits.forEach(unit => {
                if (byStaffType[unit.staffType]) {
                    byStaffType[unit.staffType].push(unit);
                }
            });
            
            Object.entries(byStaffType).forEach(([type, units]) => {
                if (units.length > 0) {
                    const totalRequired = units.reduce((sum, u) => sum + u.totalRequired, 0);
                    const totalCurrent = units.reduce((sum, u) => sum + u.currentFTE, 0);
                    const gap = totalCurrent - totalRequired;
                    const isZeroGap = isZeroValue(gap);
                    
                    html += `
                        <div class="help-card">
                            <h3>${STAFF_TYPES[type]?.icon || 'üë•'} ${type}</h3>
                            <p><strong>Skyri≈≥ skaiƒçius:</strong> ${units.length}</p>
                            <p><strong>Reikalingi FTE:</strong> ${formatNumber(totalRequired)}</p>
                            <p><strong>Turimi FTE:</strong> ${formatNumber(totalCurrent)}</p>
                            <p><strong>Balansas:</strong> 
                                <span style="color: ${isZeroGap ? 'var(--gap-zero)' : (gap < 0 ? 'var(--gap-shortage)' : 'var(--gap-surplus)')}; font-weight: 600;">
                                    ${isZeroGap ? '0.000' : (gap >= 0 ? '+' : '') + formatNumber(gap)}
                                </span>
                            </p>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        // ==============================================
        // EXPORT FUNCTIONS
        // ==============================================
        
        function exportCSV() {
            let csv = 'ITU Personalo Ataskaita v5.1\n';
            csv += `Data: ${new Date().toLocaleString('lt-LT')}\n\n`;
            
            csv += 'PAGRINDINIAI ITS SKYRIAI\n';
            csv += 'Skyrius,Tipas,Postai,Pamaina,Bazƒó FTE,Papild.,Reikia,Rankinis,Turimi,Artimu metu,Po liepos,Skirtumas,Gap %,Prioritetas,Kritinis\n';
            
            mainUnits.forEach(unit => {
                calculateUnit(unit);
                const baseFTE = FTE_STANDARDS[unit.shiftType] || 5.250;
                csv += `${unit.name},${unit.staffType},${unit.stations},${unit.shiftType},${formatNumber(baseFTE)},`;
                csv += `${formatNumber(unit.additionalFTE)},${formatNumber(unit.totalRequired)},`;
                csv += `${unit.isManualRequired ? 'Taip' : 'Ne'},`;
                csv += `${formatNumber(unit.currentFTE)},${formatNumber(unit.nearFutureFTE || unit.currentFTE)},`;
                csv += `${formatNumber(unit.afterJulyFTE || unit.nearFutureFTE || unit.currentFTE)},`;
                csv += `${formatNumber(unit.gap)},${formatPercentage(unit.gapPercentage)},`;
                csv += `${unit.priority || '-'},${unit.isCritical ? 'Taip' : 'Ne'}\n`;
            });
            
            csv += '\nSPECIALIZUOTI SKYRIAI\n';
            csv += 'Skyrius,Tipas,Postai,Pamaina,Bazƒó FTE,Papild.,Reikia,Rankinis,Turimi,Artimu metu,Po liepos,Skirtumas,Gap %,Prioritetas,Kritinis\n';
            
            specUnits.forEach(unit => {
                calculateUnit(unit);
                const baseFTE = FTE_STANDARDS[unit.shiftType] || 5.250;
                csv += `${unit.name},${unit.staffType},${unit.stations},${unit.shiftType},${formatNumber(baseFTE)},`;
                csv += `${formatNumber(unit.additionalFTE)},${formatNumber(unit.totalRequired)},`;
                csv += `${unit.isManualRequired ? 'Taip' : 'Ne'},`;
                csv += `${formatNumber(unit.currentFTE)},${formatNumber(unit.nearFutureFTE || unit.currentFTE)},`;
                csv += `${formatNumber(unit.afterJulyFTE || unit.nearFutureFTE || unit.currentFTE)},`;
                csv += `${formatNumber(unit.gap)},${formatPercentage(unit.gapPercentage)},`;
                csv += `${unit.priority || '-'},${unit.isCritical ? 'Taip' : 'Ne'}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ITU_personalo_ataskaita_v5.1_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('üìä CSV ataskaita eksportuota', 'success');
        }

        function exportReport() {
            let report = `ITU PERSONALO PLANAVIMO ATASKAITA v5.1\n`;
            report += `Sugeneruota: ${new Date().toLocaleString('lt-LT')}\n`;
            report += `${'='.repeat(60)}\n\n`;
            
            const allUnits = [...mainUnits, ...specUnits];
            allUnits.forEach(unit => calculateUnit(unit));
            
            // Group by staff type
            const byType = { 'Gydytojai': [], 'Slaugytojai': [], 'Padƒójƒójai': [] };
            allUnits.forEach(unit => {
                if (byType[unit.staffType]) byType[unit.staffType].push(unit);
            });
            
            Object.entries(byType).forEach(([type, units]) => {
                if (units.length > 0) {
                    report += `\n${type.toUpperCase()}\n`;
                    report += `${'-'.repeat(50)}\n`;
                    
                    units.forEach(unit => {
                        report += `${unit.name}:\n`;
                        report += `   Postai: ${unit.stations}, Pamaina: ${unit.shiftType}\n`;
                        report += `   Reikalingi FTE: ${formatNumber(unit.totalRequired)} ${unit.isManualRequired ? '(Rankinis)' : '(Automatinis)'}\n`;
                        report += `   Dabartiniai FTE: ${formatNumber(unit.currentFTE)}\n`;
                        report += `   Skirtumas: ${formatNumber(unit.gap)} (${formatPercentage(unit.gapPercentage)})\n`;
                        report += `   Planavimas: ${formatNumber(unit.nearFutureFTE || unit.currentFTE)} ‚Üí ${formatNumber(unit.afterJulyFTE || unit.nearFutureFTE || unit.currentFTE)}\n\n`;
                    });
                }
            });
            
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ITU_planavimo_ataskaita_v5.1_${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('üìã Detalus raportas eksportuotas', 'success');
        }

        function saveConfig() {
            const config = {
                version: '5.1',
                timestamp: new Date().toISOString(),
                mainUnits: mainUnits,
                specUnits: specUnits
            };
            
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ITU_konfiguracija_v5.1_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('üíæ Konfig≈´racija i≈°saugota', 'success');
        }

        function loadConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const config = JSON.parse(event.target.result);
                        
                        if (config.mainUnits) mainUnits = config.mainUnits;
                        if (config.specUnits) specUnits = config.specUnits;
                        
                        updateAll();
                        showToast('üìÇ Konfig≈´racija ƒØkelta sƒókmingai', 'success');
                    } catch (error) {
                        showToast('‚ùå Klaida ƒØkeliant konfig≈´racijƒÖ', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function printReport() {
            window.print();
        }

        // ==============================================
        // MAIN UPDATE FUNCTION
        // ==============================================
        
        function updateAll() {
            renderUnitsTable(mainUnits, 'mainUnitsBody', 'main');
            renderUnitsTable(specUnits, 'specUnitsBody', 'spec');
            updateDashboard();
        }

        // ==============================================
        // INITIALIZATION
        // ==============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            updateAll();
            showToast('üöÄ ITU Personalo Skaiƒçiuoklƒó v5.1 paruo≈°ta - 3 skaitmen≈≥ tikslumas!', 'success');
        });

        // Run immediately if DOM is already loaded
        if (document.readyState !== 'loading') {
            updateAll();
        }
    </script>
</body>
</html>
